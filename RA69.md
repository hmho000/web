**çº¢ç±³ax6æ€»ç»“
1ã€é‡‡ç”¨é«˜é€šä¼ä¸šçº§çš„ipq8071Aå¤„ç†å™¨ï¼Œæ€§èƒ½å¼ºåŠ²ã€‚å¤„ç†å™¨æ˜¯æ”¯æŒåŒå£ä¸‡å…†çš„ï¼Œè·‘åƒå…†å®Œå…¨æ— å‹åŠ›
2ã€cpué»˜è®¤1.4G ï¼Œå¦‚æœèƒ½è¶…é¢‘åˆ°2Gä»¥ä¸Šä¼šæ›´åŠ å®Œç¾
3ã€æ•´ä½“æ„Ÿè§‰ç¨³å®šå¯é 
xiaomimtd12.binæ–‡ä»¶ä¸‹è½½ï¼šhttps://ac2100.lanzoul.com/b01215eji å¯†ç :3ypa
æš—äº‘çš„ubootä¸‹è½½åœ°å€ï¼ˆ5å…ƒï¼‰ï¼šhttps://mbd.pub/o/bread/YpeXk5pr

å‘½ä»¤åˆ†æ®µå…·ä½“æŒ‰è§†é¢‘æ­¥éª¤æ“ä½œ
ä¸€ã€
nvram set flag_last_success=0
nvram set flag_boot_rootfs=0
nvram set flag_boot_success=1
nvram set flag_try_sys1_failed=0
nvram set flag_try_sys2_failed=0
nvram set boot_wait=on
nvram set uart_en=1
nvram set telnet_en=1
nvram set ssh_en=1
nvram commit
äºŒã€
mtd write /tmp/xiaomimtd12.bin rootfs
ä¸‰ã€
fw_setenv flag_last_success 0
fw_setenv flag_boot_rootfs 0
å››ã€
mtd erase /dev/mtd1
mtd write /tmp/ax6-mibib.bin /dev/mtd1
mtd erase /dev/mtd7
mtd write /tmp/uboot-redmi-ax6.bin /dev/mtd7**

# å°ç±³ ax6 ax3600ä¸æ­»ubootå¼•å¯¼å®˜æ–¹å’ŒQSDKäº’åˆ·

äº‘ï¼š[https://mianbaoduo.com/o/anyun/work](https://mianbaoduo.com/o/anyun/work)

å¿—å¹³ï¼š[https://www.right.com.cn/FORUM/thread-8253375-1-1.html](https://www.right.com.cn/FORUM/thread-8253375-1-1.html)

ä¸ç®¡æ˜¯æš—äº‘çš„è¿˜æ˜¯å¿—å¹³çš„éƒ½å¯ä»¥åˆ·å®˜æ–¹å»æ ¡éªŒå›ºä»¶å’ŒQSDK

1.ä¸æ­»uboot+qsdkåˆ·å®˜æ–¹å›ºä»¶ï¼šå…ˆåˆ·å®˜æ–¹åŸå‚mibibåˆ†åŒºæ–‡ä»¶ï¼Œé‡å¯åè¿›ubootåˆ·å®˜æ–¹ubiå³å¯

2.ä¸æ­»uboot+å®˜æ–¹åˆ·qsdkå›ºä»¶ï¼šå…ˆåˆ·qsdkå¤§åˆ†åŒºmibibæ–‡ä»¶ï¼Œé‡å¯åè¿›ubootåˆ·qsdkå³å¯

sshä¸Šä¼ å¯¹åº”mibibåˆ°tmpç›®å½•

ä¾æ¬¡è¾“å…¥3è¡Œå‘½ä»¤

mtd erase /dev/mtd1

mtd write /tmp/mibib.bin /dev/mtd1

reboot

å…ˆæŒ‰ä½resetæ’ç”µåç­‰å¾…10ç§’æ¾å¼€reset

ipå›ºä»¶192.168.1.2  225.225.225.0

æµè§ˆå™¨æ‰“å¼€192.168.1.1å³å¯è¿›å…¥ubootåˆ·å›ºä»¶

**å‰è¨€ï¼š**

è¯¥å›ºä»¶ä¸»è¦æ˜¯è‡ªå·±ç¼–è¯‘æ¥å®¶é‡Œçš„çº¢ç±³ AX6 ä½¿ç”¨çš„ã€‚å¯¹äºè‡ªå·±çš„ä½¿ç”¨æƒ…å†µï¼Œéœ€è¦çš„åŠŸèƒ½æ¯”è¾ƒå°‘ï¼Œæ‹¨å·ä¸Šç½‘ï¼Œè¿ç¦è¯è¯­æ‰“å€’ç¾å¸ï¼Œç„¶åå°±æ²¡äº†ã€‚ã€‚ã€‚æ‰€ä»¥æ­¤å›ºä»¶é›†æˆçš„ä¸œè¥¿å¾ˆå°‘ã€‚éœ€è¦å…¶ä»–æ’ä»¶çš„éº»çƒ¦è‡ªè¡Œå®‰è£…ä¸€ä¸‹ã€‚

 **éœ€è¦å…¶ä»–æ’ä»¶çš„éº»çƒ¦è‡ªè¡Œå®‰è£…ä¸€ä¸‹ã€‚** æ¯ä¸ªäººçš„éœ€æ±‚éƒ½ä¼šæœ‰äº›ä¸åŒï¼Œå¯¹äºæˆ‘è€Œè¨€ï¼Œå°±è¿™æ ·å­å°±å¤Ÿäº†ã€‚ä¹Ÿè®¸ï¼Œå“ªå¤©ï¼Œæƒ³è¯•è¯•æŸä¸ªæ’ä»¶æ—¶ï¼Œä¾¿ä¼šåœ¨ç¼–è¯‘æ—¶ä¸€åŒç¼–è¯‘è¿›å»ï¼Œå¯èƒ½ä¸‹ä¸€ä¸ªç‰ˆæœ¬å°±å»æ‰ã€‚

å°½å¯èƒ½çš„ä¸æ·»åŠ å¤ªå¤šçš„ä¸œè¥¿ï¼Œé…¸çˆ½ä¹³æ¯æ¬¡éƒ½ä¼šæœ‰ï¼ˆè¿™æ˜¯æˆ‘å¿…é¡»ç”¨åˆ°çš„ï¼‰ã€‚è‡³äºå…¶å®ƒçš„ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¸ä¼šé›†æˆè¿›å»ã€‚

çº¢ç±³AX6 çš„å›ºä»¶ï¼Œä¼šæ›´æ–°çš„æ…¢ç‚¹ã€‚

å¸–å­é‡Œæ›´æ–°ä¸ä¸€å®šåŠæ—¶ï¼Œä¸€èˆ¬äº‘ç¼–è¯‘åï¼Œæˆ‘è‡ªå·±å›å®¶æ›´æ–°äº†åæ‰ä¼šåŒæ­¥åˆ°å¸–å­é‡Œã€‚ç€æ€¥çš„è¯ï¼Œå¯ä»¥åœ¨ [https://github.com/hochenchong/Actions-OpenWrt/releases](https://github.com/hochenchong/Actions-OpenWrt/releases) æ‰¾ä¸€ä¸‹æ˜¯å¦æœ‰æœ€æ–°ç¼–è¯‘çš„å›ºä»¶

**æœ€è¿‘è‡ªåŠ¨ç¼–è¯‘çš„å›ºä»¶éƒ½æ˜¯ç¼ºå¤±äº†æ— çº¿ï¼Œæºç å·²ç»æœ‰äººåé¦ˆäº†ï¼Œæš‚æ—¶è¿˜æ²¡ä¿®å¤**

**æš‚æ—¶ç…§ç€ [https://github.com/coolsnowwolf/lede/issues/11182](https://github.com/coolsnowwolf/lede/issues/11182) é‡Œå…ˆå›æ»šåˆ°æŸä¸ªç‰ˆæœ¬æ¥ç¼–è¯‘ï¼Œç­‰å¾…å®˜æ–¹ä¿®å¤åå†è¯´äº†**

 **ï¼ˆä¹Ÿå°±æ˜¯è¯´æœ€è¿‘ç¼–è¯‘çš„å†…æ ¸ç‰ˆæœ¬ä¼šä¸€è‡´ï¼Œå°±é›†æˆçš„æ’ä»¶è¿›è¡Œäº†æ›´æ–°ï¼Œæ¯”å¦‚è¯´é…¸çˆ½ä¹³æ”¯æŒæœ€æ–°çš„åè®®** **ï¼‰ã€‚**

**å›ºä»¶è¯´æ˜ï¼š**

1. ç¼–è¯‘æ—¶é—´ï¼š20230616
2. å†…æ ¸ç‰ˆæœ¬ï¼š5.10.176
3. å›ºä»¶ç‰ˆæœ¬ï¼šOpenWrt R23.5.1 / LuCI Master (git-23.163.54516-50f4225)
4. ç¼–è¯‘çš„æºç å–è‡ªï¼š[https://github.com/coolsnowwolf/lede](https://github.com/coolsnowwolf/lede)
5. é›†æˆæ’ä»¶ï¼šé…¸çˆ½ä¹³ã€TTYD ç»ˆç«¯
6. é»˜è®¤ä¸»é¢˜ï¼šArgonï¼ˆå›ºä»¶é‡Œä¹ŸåªåŒ…å«äº†è¿™ä¸ªä¸»é¢˜ï¼‰
7. é»˜è®¤ç³»ç»Ÿåå°ï¼š192.168.123.1ï¼Œè´¦å·ï¼šrootï¼Œå¯†ç ï¼špassword

**ä¸‹è½½é“¾æ¥ï¼š**

ç™¾åº¦ç½‘ç›˜é“¾æ¥ï¼š[https://pan.baidu.com/s/1zBtzdk1ERG4SYeTHu-b2lw](https://pan.baidu.com/s/1zBtzdk1ERG4SYeTHu-b2lw)

æå–ç ï¼š2333

**åˆ·å…¥æ–¹å¼ï¼š**

å‚è€ƒï¼š[å°ç±³çº¢ç±³è·¯ç”±å™¨AX6åˆ·ç¬¬ä¸‰æ–¹openwrtå›ºä»¶](https://www.right.com.cn/forum/thread-4111331-1-1.html)

å¦‚æœå·²ç»åˆ·äº†å…¶ä»–çš„ openwrt å›ºä»¶ï¼Œåˆ™å¯ä»¥å‚è€ƒ [[Redmi AX6] AX6ä»leançš„LEDEå›ºä»¶åˆ·å›å¿—å¹³çš„QSDKå›ºä»¶æ•™ç¨‹](https://www.right.com.cn/forum/thread-5326459-1-1.html)

æŒ‰è´´ä¸­æ•™ç¨‹ï¼Œ**åŒºåˆ«åœ¨äºï¼šå°†ç¬¬ä¸‰æ­¥çš„ åˆ·æœºåŒ… æ¢æˆç½‘ç›˜é‡Œ openwrt-ipq807x-generic-redmi_ax6-squashfs-nand-factory.ubi å³å¯**

**å¦‚æœæ˜¯åˆ·çš„æ˜¯å†å²ç‰ˆæœ¬ï¼Œå‡çº§å»ºè®®ï¼š**

1. ç³»ç»Ÿ - å¤‡ä»½/æ¢å¤ - ç”Ÿæˆå¤‡ä»½ï¼Œä¸‹è½½é…ç½®çš„å¤‡ä»½æ–‡ä»¶
2. ç³»ç»Ÿ - å¤‡ä»½/æ¢å¤ - æ‰§è¡Œé‡ç½®
3. ä¸ä¿ç•™é…ç½®ï¼Œä½¿ç”¨ openwrt-ipq807x-generic-redmi_ax6-squashfs-nand-sysupgrade.bin å‡çº§
4. å‡çº§ä¹‹åï¼Œå†ä½¿ç”¨ç¬¬ä¸€æ­¥çš„å¤‡ä»½æ–‡ä»¶è¿›è¡Œæ¢å¤é…ç½®å³å¯

 **å†å²ç‰ˆæœ¬ï¼š** å†å²ç‰ˆæœ¬ç›´æ¥çœ‹ç½‘ç›˜å§ï¼ŒåŸºæœ¬ä¸ŠåŒºåˆ«åœ¨äºç¼–è¯‘æ—¶é—´ã€å†…æ ¸ç‰ˆæœ¬ã€å›ºä»¶ç‰ˆæœ¬ï¼Œå¯¹åº”çš„å›ºä»¶æœ‰æˆªå›¾ä¿¡æ¯ã€‚

å…³äºè¿™ä¸ªå›ºä»¶ï¼Œåœ¨ LEDE å›ºä»¶é‡Œï¼Œæ˜¯ç§»é™¤äº† ax6 ç›¸å…³çš„ï¼Œå…·ä½“çš„çº çº·å°±æ²¡å»ç ”ç©¶äº†ï¼Œå¯ä»¥çœ‹è¿™æ¬¡æäº¤ï¼š[ipq807x: drop all xiaomi devices support](https://github.com/coolsnowwolf/lede/commit/edbd8d2e9839357f3a4f0a06174d243f362b1544)

åœ¨ 2022å¹´11æœˆæ—¶ï¼ŒLå¤§åˆæŠŠ ax6 ç›¸å…³çš„å¤§éƒ¨åˆ†å†…å®¹æ·»åŠ å›å»äº†ã€‚

è‡ªå·±ç¼–è¯‘çš„è¯ï¼Œä¸ç”¨å†å›æ»šé‚£æ¬¡ç§»é™¤çš„æäº¤ï¼Œåªç”¨ä¿®æ”¹ target/linux/ipq807x/image/generic.mk è¿™ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ å› ax6 çš„é…ç½®å³å¯

1. define Device/redmi_ax6
2. $(call Device/xiaomi_ax3600)
3. DEVICE_VENDOR := Redmi
4. DEVICE_MODEL := AX6
5. DEVICE_PACKAGES := ipq-wifi-redmi_ax6 uboot-envtools
6. endef
7. TARGET_DEVICES += redmi_ax6

æˆ–è€…å°† [https://github.com/hochenchong/Actions-OpenWrt/blob/main/ax6/generic.mk](https://github.com/hochenchong/Actions-OpenWrt/blob/main/ax6/generic.mk) æ•´ä¸ªæ–‡ä»¶æ›¿æ¢æ‰ target/linux/ipq807x/image/generic.mk å³å¯ã€‚

è‡ªå·±çš„äº‘ç¼–è¯‘é¡¹ç›®ï¼Œå°±æ˜¯ç›´æ¥æ›¿æ¢æ‰è¿™ä¸ªæ–‡ä»¶

1. cp -rf $GITHUB_WORKSPACE/ax6/generic.mk openwrt/target/linux/ipq807x/image/generic.mk

## bç«™ä¸Š upä¸»æ˜¯çœŸçš„å¼º

Redmi AX6 çš„ä¸‰ç§å›ºä»¶å¸ƒå±€åˆ†åˆ«ä»£è¡¨ä¸åŒçš„å›ºä»¶è®¾è®¡æˆ–ç”¨é€”ï¼Œä»¥ä¸‹æ˜¯å®ƒä»¬çš„å«ä¹‰å’Œç‰¹ç‚¹ï¼š

---

### 1. **è‡ªå®šä¹‰ U-Boot å¸ƒå±€ (Custom U-Boot Layout)**

 **å®šä¹‰** ï¼šä¿®æ”¹äº†è®¾å¤‡çš„åŸå§‹ U-Bootï¼ˆè·¯ç”±å™¨çš„å¼•å¯¼ç¨‹åºï¼‰å¸ƒå±€ï¼Œç”¨äºå®ç°æ›´å¤šåŠŸèƒ½æˆ–é€‚é…ç‰¹å®šå›ºä»¶ã€‚

 **ç‰¹ç‚¹** ï¼š

* å¯ä»¥çµæ´»å¼•å¯¼ä¸åŒå›ºä»¶ï¼ˆä¾‹å¦‚ OpenWrtã€ImmortalWrt æˆ–åŸå‚å›ºä»¶ï¼‰ã€‚
* æ”¯æŒå¤šç§å¼•å¯¼æ–¹å¼ï¼ˆTFTPã€ä¸²å£ç­‰ï¼‰ï¼Œæ–¹ä¾¿è°ƒè¯•æˆ–æ¢å¤ã€‚
* é€šå¸¸æ‰©å±•äº†é—ªå­˜åˆ†åŒºçš„çµæ´»æ€§ï¼Œå¯ä»¥ä¸ºç³»ç»Ÿå›ºä»¶å’Œå­˜å‚¨åˆ†é…æ›´å¤šç©ºé—´ã€‚

 **é€‚ç”¨åœºæ™¯** ï¼š

* é«˜çº§ç”¨æˆ·å¸Œæœ›å®šåˆ¶å¼•å¯¼ç¨‹åºï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†è·¯ç”±å™¨ã€‚
* éœ€è¦å…¼å®¹å¤šä¸ªå›ºä»¶æˆ–æ¢å¤ç³»ç»Ÿã€‚

---

### 2. **OpenWrt æ‰©å±•å¸ƒå±€ (OpenWrt Expand Layout)**

 **å®šä¹‰** ï¼šè¿™æ˜¯åŸºäº OpenWrt çš„è‡ªå®šä¹‰åˆ†åŒºå¸ƒå±€ï¼Œä¼˜åŒ–é—ªå­˜åˆ†åŒºä»¥æå‡å›ºä»¶çš„åŠŸèƒ½å’Œå­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡ã€‚

 **ç‰¹ç‚¹** ï¼š

* ä¿®æ”¹äº†åŸå‚é—ªå­˜åˆ†åŒºï¼Œå°†æ›´å¤šç©ºé—´åˆ†é…ç»™ rootfsï¼ˆæ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚
* å¯ä»¥å®‰è£…æ›´å¤š OpenWrt æ’ä»¶ï¼Œå¦‚ Sambaã€Adblock æˆ– VPNã€‚
* é€šå¸¸å°†åŸå‚å›ºä»¶çš„éƒ¨åˆ†åŠŸèƒ½è£å‰ªæ‰ï¼ˆä¾‹å¦‚ä¿ç•™æ¢å¤åˆ†åŒºï¼Œç§»é™¤å…¶ä»–æ— ç”¨çš„åŠŸèƒ½åˆ†åŒºï¼‰ã€‚

 **é€‚ç”¨åœºæ™¯** ï¼š

* ç”¨æˆ·ä»¥ OpenWrt ä¸ºä¸»ï¼Œæ³¨é‡å¯æ‰©å±•æ€§å’ŒåŠŸèƒ½å¢å¼ºã€‚
* é€‚åˆè¿è¡Œå¤§è§„æ¨¡æ’ä»¶æˆ–å¤æ‚çš„ç½‘ç»œç¯å¢ƒã€‚

---

### 3. **åŸå‚å¸ƒå±€ (Stock Layout)**

 **å®šä¹‰** ï¼šè®¾å¤‡å‡ºå‚æ—¶çš„é»˜è®¤åˆ†åŒºå’Œå›ºä»¶å¸ƒå±€ï¼Œå®Œå…¨ä¿ç•™å°ç±³å®˜æ–¹æä¾›çš„åŠŸèƒ½å’Œè®¾è®¡ã€‚

 **ç‰¹ç‚¹** ï¼š

* ä¿æŒå°ç±³è·¯ç”±å™¨çš„å®˜æ–¹ç‰¹æ€§å’Œç®¡ç†ç•Œé¢ã€‚
* åˆ†åŒºç»“æ„è¾ƒå›ºå®šï¼Œç”¨æˆ·è‡ªå®šä¹‰æ‰©å±•æ€§è¾ƒå·®ã€‚
* ä¸€èˆ¬ä¿ç•™åŸå‚æ¢å¤åŠŸèƒ½ï¼ˆå¦‚é€šè¿‡å®˜æ–¹ Web ç•Œé¢æ¢å¤å›ºä»¶ï¼‰ã€‚

 **é€‚ç”¨åœºæ™¯** ï¼š

* æ™®é€šç”¨æˆ·åªéœ€è¦åŸºæœ¬åŠŸèƒ½ï¼ˆå¦‚å®¶åº­ WiFi å’Œç®€å•çš„ç½‘ç»œè®¾ç½®ï¼‰ã€‚
* ä¸éœ€è¦è¿è¡Œç¬¬ä¸‰æ–¹å›ºä»¶æˆ–è‡ªå®šä¹‰é…ç½®ã€‚

---

### æ€»ç»“

| å¸ƒå±€ç±»å‹           | çµæ´»æ€§ | åŠŸèƒ½æ‰©å±•æ€§ | æ“ä½œéš¾åº¦ | æ¨èç”¨æˆ·     |
| ------------------ | ------ | ---------- | -------- | ------------ |
| è‡ªå®šä¹‰ U-Boot å¸ƒå±€ | é«˜     | é«˜         | é«˜       | é«˜çº§ç”¨æˆ·     |
| OpenWrt æ‰©å±•å¸ƒå±€   | ä¸­     | é«˜         | ä¸­       | OpenWrt ç”¨æˆ· |
| åŸå‚å¸ƒå±€           | ä½     | ä½         | ä½       | æ™®é€šç”¨æˆ·     |

æˆ‘ç°åœ¨æ˜¯åˆ†åŒºè¡¨

root@OpenWrt:~# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00100000 00020000 "0:sbl1"
mtd1: 00100000 00020000 "0:mibib"
mtd2: 00300000 00020000 "0:qsee"
mtd3: 00080000 00020000 "0:devcfg"
mtd4: 00080000 00020000 "0:rpm"
mtd5: 00080000 00020000 "0:cdt"
mtd6: 00080000 00020000 "0:appsblenv"
mtd7: 00100000 00020000 "0:appsbl"
mtd8: 00080000 00020000 "0:art"
mtd9: 00080000 00020000 "bdata"
mtd10: 00080000 00020000 "crash"
mtd11: 00080000 00020000 "crash_syslog"
mtd12: 023c0000 00020000 "rootfs"
mtd13: 023c0000 00020000 "rootfs_1"
mtd14: 01ec0000 00020000 "overlay"
mtd15: 00080000 00020000 "rsvd0"

ä»ä½ çš„åˆ†åŒºå¸ƒå±€æ¥çœ‹ï¼ŒRedmi AX6 çš„é—ªå­˜è¢«åˆ†ä¸ºå¤šä¸ªå°åˆ†åŒºï¼Œå…¶ä¸­ä¸€äº›æ˜¯ç³»ç»Ÿå…³é”®åˆ†åŒºï¼Œå¦ä¸€äº›æ˜¯ç”¨äºå­˜å‚¨æ“ä½œç³»ç»Ÿï¼ˆOpenWrt æˆ–å…¶ä»–å›ºä»¶ï¼‰çš„åˆ†åŒºã€‚ä»¥ä¸‹æ˜¯å…³é”®åˆ†åŒºçš„è§£é‡Šå’Œå¦‚ä½•è°ƒæ•´å®ƒä»¬çš„å»ºè®®ï¼š

---

### **åˆ†åŒºå¸ƒå±€åˆ†æ**

| åˆ†åŒºåç§°                | å¤§å°   | è¯´æ˜                                                                 |
| ----------------------- | ------ | -------------------------------------------------------------------- |
| `mtd0-mtd7`           | å°åˆ†åŒº | å„ç§å¼•å¯¼ç›¸å…³åˆ†åŒºï¼ˆå¦‚ SBL1ã€QSEEã€Appsblï¼‰ï¼Œè´Ÿè´£è®¾å¤‡å¯åŠ¨è¿‡ç¨‹ã€‚        |
| `mtd8`(`art`)       | 512 KB | ä¿å­˜ WiFi å°„é¢‘æ ¡å‡†æ•°æ®ï¼ˆéå¸¸é‡è¦ï¼Œåˆ‡å‹¿åˆ é™¤ï¼‰ã€‚                       |
| `mtd9`(`bdata`)     | 512 KB | ä¿å­˜è®¾å¤‡ç¡¬ä»¶ä¿¡æ¯ï¼ˆå¦‚ MAC åœ°å€ã€åºåˆ—å·ç­‰ï¼‰ã€‚                          |
| `mtd12`(`rootfs`)   | 36 MB  | ä¸»ç³»ç»Ÿåˆ†åŒºï¼Œç”¨äºå­˜å‚¨è¿è¡Œçš„ OpenWrt æ–‡ä»¶ç³»ç»Ÿã€‚                        |
| `mtd13`(`rootfs_1`) | 36 MB  | å¤‡ç”¨ç³»ç»Ÿåˆ†åŒºï¼ŒåŸå‚å›ºä»¶ç”¨äºåŒåˆ†åŒºå†—ä½™æ›´æ–°æœºåˆ¶ï¼ŒOpenWrt ä¸­é€šå¸¸æœªç”¨åˆ°ã€‚ |
| `mtd14`(`overlay`)  | 31 MB  | ç”¨æˆ·å­˜å‚¨åˆ†åŒºï¼Œç”¨äºä¿å­˜é…ç½®å’Œæ’ä»¶ï¼ˆåœ¨ OpenWrt ä¸­ä½œä¸º `/overlay`ï¼‰ã€‚ |
| `mtd15`(`rsvd0`)    | 512 KB | ä¿ç•™åˆ†åŒºï¼Œå¯èƒ½å­˜æ”¾æ—¥å¿—æˆ–è°ƒè¯•ä¿¡æ¯ã€‚                                   |

---

### **è°ƒæ•´åˆ†åŒºçš„ç›®çš„**

1. **é‡Šæ”¾å¤‡ç”¨åˆ†åŒºç©ºé—´ (`rootfs_1`)ï¼š**
   * å¤‡ç”¨åˆ†åŒºï¼ˆ`rootfs_1`ï¼‰åœ¨ OpenWrt ä¸­é€šå¸¸æœªè¢«ä½¿ç”¨ã€‚å¯ä»¥å°†å…¶ä¸ä¸»åˆ†åŒºåˆå¹¶ï¼Œå¢åŠ ç³»ç»Ÿå­˜å‚¨ç©ºé—´ã€‚
2. **å¢å¤§ Overlay åˆ†åŒºï¼š**
   * `/overlay` æ˜¯ç”¨æˆ·å­˜å‚¨åˆ†åŒºï¼Œç©ºé—´è¾ƒå°ï¼ˆ31 MBï¼‰ã€‚æ‰©å±•æ­¤åˆ†åŒºå¯ä»¥å®¹çº³æ›´å¤šæ’ä»¶å’Œé…ç½®ã€‚
3. **ä¿ç•™é‡è¦åˆ†åŒºï¼š**
   * ä¾‹å¦‚ `art` å’Œ `bdata`ï¼Œè¿™äº›åˆ†åŒºå¯¹è·¯ç”±å™¨ç¡¬ä»¶åŠŸèƒ½è‡³å…³é‡è¦ï¼Œåˆ‡å‹¿è¦†ç›–æˆ–åˆ é™¤ã€‚

---

### **ä¿®æ”¹åˆ†åŒºå¸ƒå±€çš„æ­¥éª¤**

#### **1. å¤‡ä»½é‡è¦åˆ†åŒº**

åœ¨è°ƒæ•´åˆ†åŒºä¹‹å‰ï¼Œå…ˆå¤‡ä»½é‡è¦åˆ†åŒºæ•°æ®ï¼š

```bash
mkdir /tmp/backup
for part in /dev/mtd{0..15}; do
    dd if=$part of=/tmp/backup/$(basename $part).bin
done
```

å°†å¤‡ä»½æ–‡ä»¶ä¼ è¾“åˆ°æœ¬åœ°ï¼š

```bash
scp /tmp/backup/*.bin user@<ä½ çš„ç”µè„‘IP>:~/router_backup/
```

#### **2. ä¿®æ”¹åˆ†åŒºè¡¨**

**æ–¹æ³• 1ï¼šé€šè¿‡è®¾å¤‡æ ‘æ–‡ä»¶ï¼ˆDTSï¼‰è°ƒæ•´åˆ†åŒº**

1. æå–å½“å‰è®¾å¤‡æ ‘ï¼š
   ```bash
   dtc -I fs -O dts /sys/firmware/devicetree/base > /tmp/current.dts
   ```
2. ç¼–è¾‘ `/tmp/current.dts` æ–‡ä»¶ï¼Œæ‰¾åˆ° `partitions` èŠ‚ç‚¹ï¼Œè°ƒæ•´ `rootfs` å’Œ `rootfs_1` çš„å¤§å°ã€‚ä¾‹å¦‚ï¼š
   ```dts
   partition@c00000 {
       label = "rootfs";
       reg = <0xc00000 0x47c0000>; // å¢å¤§ rootfs å¤§å°
   };
   partition@53c0000 {
       label = "overlay";
       reg = <0x53c0000 0x4ec0000>; // å°† rootfs_1 åˆå¹¶åˆ° overlay
   };
   ```
3. é‡æ–°ç¼–è¯‘ DTS å¹¶åº”ç”¨ï¼š
   ```bash
   dtc -I dts -O dtb /tmp/current.dts > /tmp/new.dtb
   cp /tmp/new.dtb /boot/devicetree.dtb
   ```

**æ–¹æ³• 2ï¼šç›´æ¥ä¿®æ”¹å†…æ ¸åˆ†åŒºæ˜ å°„**

1. ç¼–è¾‘ `/etc/config/fstab` æˆ–æŒ‚è½½è„šæœ¬ï¼š
   * åˆå¹¶ `rootfs_1` åˆ°ä¸»åˆ†åŒºã€‚
   * é‡æ–°æŒ‚è½½ `/overlay`ï¼Œæ‰©å±•å…¶ç©ºé—´ã€‚
   * ç¡®ä¿æ–°çš„æŒ‚è½½ç”Ÿæ•ˆåé‡å¯ã€‚

---

### **æ³¨æ„äº‹é¡¹**

* **åŒåˆ†åŒºæœºåˆ¶ï¼š** ä¿®æ”¹åå¯èƒ½ä¸§å¤±åŸå‚å›ºä»¶çš„åŒåˆ†åŒºæ›´æ–°åŠŸèƒ½ã€‚
* **æ ¡å‡†æ•°æ®ä¿æŠ¤ï¼š** ç¡®ä¿ `art` å’Œ `bdata` ä¸è¢«æ”¹åŠ¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ— çº¿æˆ–ç¡¬ä»¶åŠŸèƒ½å¼‚å¸¸ã€‚
* **æ¢å¤æ‰‹æ®µï¼š** åœ¨æ“ä½œå‰å‡†å¤‡å¥½ TTL ä¸²å£å·¥å…·ï¼Œä»¥é˜²è®¾å¤‡å˜ç –ã€‚

root@OpenWrt:~# fw_printenv
bootcmd=tftp
bootdelay=5
SN=29164/A0UA39193
ethaddr="00:AA:BB:CC:DD:10"
ipaddr=192.168.31.1
serverip=192.168.31.100
stdin=serial
stdout=serial
stderr=serial
uart_en=1
telnet_en=0
wl0_ssid=Redmi_D6C1_293E_5G
wl1_ssid=Redmi_D6C1_293E
wl0_radio=1
wl1_radio=1
boot_wait=on
flag_boot_rootfs=0
no_wifi_dev_times=0
flag_boot_type=2
CountryCode=CN
flag_last_success=0
flag_ota_reboot=0
color=100
miot_did=484246315
miot_key=yKxCLBTdN45gLzUv
nv_wan_type=
flag_boot_success=1
flag_try_sys1_failed=0
flag_try_sys2_failed=0
nv_pppoe_name=13562990459
nv_pppoe_pwd=906875
Router_unconfigured=0
mode=AP
model=RA69
nv_sys_pwd=efc9ff38a393c58197c8ebda78c3ad6d61fb25c7
nv_wifi_ssid=54188@DD.com
nv_wifi_enc=mixed-psk
nv_wifi_pwd=dsc770556
nv_wifi_ssid1=54188@DD.com
nv_wifi_enc1=mixed-psk
nv_wifi_pwd1=dsc770556
flag_show_upgrade_info=0
restore_defaults=0
ssh_en=1

çœ‹æ¥é™çº§ æŠŠä¸¤ä¸ªåˆ†åŒºéƒ½å˜æˆäº† æœ‰åé—¨çš„ç³»ç»Ÿ

nvram get flag_last_success      æ£€æŸ¥ä¸Šæ¬¡å¯åŠ¨æˆåŠŸï¼Ÿ

æˆ‘æ˜¯è¿™ä¸ªåˆ†åŒº 0  é‚£ä¹ˆæˆ‘åœ¨ä»€ä¹ˆåˆ†åŒº  æˆ‘çš„é™çº§å›ºä»¶åœ¨ 13åˆ†åŒº

********** å¦‚æœè¿”å›åˆ†åŒºæ•°å­—ä¸º0ï¼Œè¯·æ‰§è¡Œä¸‹é¢æ“ä½œï¼š**********
1ã€åˆ‡æ¢å½“å‰å¯åŠ¨çš„ç³»ç»Ÿåˆ†åŒºä¸º13åˆ†åŒº
     nvram set flag_last_success=1
     nvram set flag_boot_rootfs=1
     nvram commit
     reboot
2ã€åœ¨Winscpä¸­ä¸Šä¼ OPå›ºä»¶åˆ°è·¯ç”±å™¨çš„/tmpç›®å½•
3ã€åˆ·å…¥OPå›ºä»¶å¹¶åˆ‡æ¢å¯åŠ¨åˆ†åŒºï¼š
     â‘  ç™»å½•SSHï¼šssh root@192.168.31.1
     â‘¡ åˆ·å…¥OPå›ºä»¶ ubiformat /dev/mtd12 -y -f /tmp/ä½ ä¸Šä¼ çš„å›ºä»¶æ–‡ä»¶å
     â‘¢ åˆ‡æ¢å¯åŠ¨åˆ†åŒºä¸º13åˆ†åŒºï¼›                åº”è¯¥åˆ°12åˆ†åŒºå¯åŠ¨
	nvram set flag_last_success=0
	nvram set flag_boot_rootfs=0
	nvram commit
	reboot

OPåˆ‡æ¢åˆ°å°ç±³ç³»ç»Ÿ
fw_setenv  flag_last_success 1
fw_setenv flag_boot_rootfs 1
reboot

å°ç±³ç³»ç»Ÿåˆ‡æ¢åˆ°OP
nvram set flag_last_success=0
nvram set flag_boot_rootfs=0
nvram commit
reboot

---

## å¤‡ä»½ åˆ†åŒº

 strings /dev/mtd12 | grep -i openwrt
ARM64 OpenWrt FIT (Flattened Image Tree)
ARM64 OpenWrt Linux-5.10.176
ARM64 OpenWrt redmi_ax6 device tree blob
OpenWrt redmi_ax6

fSopenwrt_releaseIBmEJb
openwrt_release
openwrt_releaseIBmEJb
openwrt_releaseeIigdF
openwrt_release
openwrt_releaseeIigdF
OpenWrt9e633aab
openwrt_release
DISTRIB_ID='OpenWrt'
DISTRIB_DESCRIPTION='OpenWrt '
OpenWrt9e633aab
openwrt_releasemILeef
openwrt_release
openwrt_releasemILeef
openwrt_releaseMjlcFb
8Mopenwrt_release
1openwrt_releaseMjlcFb
DISTRIB_ID='OpenWrt'
DISTRIB_DESCRIPTION='OpenWrt

---

### **å…³é”®æ ‡å¿—ä½è§£é‡Š**

1. **å¼•å¯¼åˆ†åŒºæ ‡å¿—ä½**
   * `flag_boot_rootfs=0`: å½“å‰å¯åŠ¨çš„åˆ†åŒºä¸º `mtd12`ï¼ˆ`rootfs`ï¼‰ï¼Œè¿™æ˜¯ä½ çš„ OpenWrt åˆ†åŒºã€‚
   * `flag_last_success=0`: ä¸Šæ¬¡æˆåŠŸå¯åŠ¨çš„æ˜¯ `mtd12` åˆ†åŒºã€‚
   * `flag_try_sys1_failed=0`: è¡¨ç¤ºæ²¡æœ‰å°è¯•å¤±è´¥çš„è®°å½•ï¼ˆä¸ `mtd12` åˆ†åŒºç›¸å…³ï¼‰ã€‚
   * `flag_try_sys2_failed=0`: è¡¨ç¤ºæ²¡æœ‰å°è¯•å¤±è´¥çš„è®°å½•ï¼ˆä¸ `mtd13` åˆ†åŒºç›¸å…³ï¼‰ã€‚
2. **å…¶ä»–æ ‡å¿—ä½**
   * `bootcmd=tftp`: é»˜è®¤å¼•å¯¼å‘½ä»¤ï¼ˆå¦‚æœä½ éœ€è¦æ¢å¤æˆ–åˆ·æœºæ—¶ä½¿ç”¨ TFTPï¼‰ã€‚
   * `uart_en=1` å’Œ `ssh_en=1`: è¡¨ç¤ºä¸²å£å’Œ SSH å·²è§£é”ï¼Œå¯ä»¥è‡ªç”±ä½¿ç”¨è¿™ä¸¤ç§æ–¹å¼è¿›è¡Œè°ƒè¯•æˆ–ç®¡ç†ã€‚
   * `flag_boot_type=2`: ç³»ç»Ÿçš„å¯åŠ¨ç±»å‹æ ‡å¿—ï¼Œä¸åŸå‚æ›´æ–°æœºåˆ¶ç›¸å…³ã€‚
3. **å½“å‰ç¯å¢ƒ**
   * ä½ çš„è·¯ç”±å™¨å½“å‰è¿è¡Œ OpenWrtï¼Œå¹¶ä¸”ä» `mtd12`ï¼ˆ`rootfs`ï¼‰åˆ†åŒºå¯åŠ¨ã€‚
   * åŸå‚å›ºä»¶å¯èƒ½ä»ä¿ç•™åœ¨ `mtd13`ï¼ˆ`rootfs_1`ï¼‰ã€‚

---

### **å¦‚ä½•åˆ‡æ¢åˆ°åŸå‚å›ºä»¶ï¼ˆ`mtd13`ï¼‰**

å¦‚æœä½ éœ€è¦åˆ‡æ¢åˆ°åŸå‚å›ºä»¶æ‰€åœ¨çš„åˆ†åŒºï¼ˆ`mtd13`ï¼‰ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š

```bash
fw_setenv flag_last_success 1
fw_setenv flag_boot_rootfs 1
reboot
```

æ‰§è¡Œä»¥ä¸Šå‘½ä»¤åï¼Œè·¯ç”±å™¨å°†é‡å¯å¹¶ä» `mtd13` åˆ†åŒºï¼ˆåŸå‚å›ºä»¶ï¼‰å¯åŠ¨ã€‚

---

### **å¦‚ä½•åˆ‡æ¢å› OpenWrtï¼ˆ`mtd12`ï¼‰**

å½“éœ€è¦åˆ‡æ¢å› OpenWrt åˆ†åŒºï¼ˆ`mtd12`ï¼‰æ—¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
fw_setenv flag_last_success 0
fw_setenv flag_boot_rootfs 0
reboot
```

è®¾å¤‡å°†é‡å¯å¹¶åŠ è½½ `mtd12` çš„ OpenWrt ç³»ç»Ÿã€‚

---

### **å…¶ä»–æ“ä½œå»ºè®®**

#### **1. å¤‡ä»½å½“å‰é…ç½®**

æ— è®ºä½ æ˜¯å¦ä¿®æ”¹é…ç½®ï¼Œå»ºè®®å…ˆå¤‡ä»½å½“å‰ç¯å¢ƒï¼Œä»¥é˜²æ“ä½œé”™è¯¯å¯¼è‡´æ— æ³•æ¢å¤ï¼š

```bash
mkdir -p /tmp/backup
fw_printenv > /tmp/backup/fw_env.txt
dd if=/dev/mtd8 of=/tmp/backup/mtd8_nvram.bin
scp -r /tmp/backup user@<ä½ çš„ç”µè„‘IP>:~/router_backup/
```

#### **2. ç¡®è®¤åˆ†åŒºçŠ¶æ€**

é€šè¿‡æ£€æŸ¥åˆ†åŒºå†…å®¹æ¥ç¡®ä¿æ¯ä¸ªåˆ†åŒºçš„ç”¨é€”ï¼š

```bash
strings /dev/mtd12 | grep -i openwrt
strings /dev/mtd13 | grep -i xiaomi
```

è¿™å¯ä»¥å¸®åŠ©ä½ ç¡®è®¤ `mtd13` æ˜¯å¦è¿˜å­˜æœ‰åŸå‚å›ºä»¶ã€‚

#### **3. åˆ·å†™å›ºä»¶**

å¦‚æœä½ éœ€è¦åœ¨ä»»ä½•åˆ†åŒºåˆ·å…¥æ–°çš„å›ºä»¶ï¼Œä¾‹å¦‚å°† OpenWrt åˆ·åˆ° `mtd13`ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. ä¸Šä¼ å›ºä»¶åˆ° `/tmp` ç›®å½•ï¼š
   ```bash
   scp openwrt-firmware.bin root@192.168.31.1:/tmp/
   ```
2. åˆ·å†™åˆ° `mtd13`ï¼š
   ```bash
   ubiformat /dev/mtd13 -y -f /tmp/openwrt-firmware.bin
   ```
3. åˆ‡æ¢å¯åŠ¨åˆ° `mtd13`ï¼š
   ```bash
   fw_setenv flag_last_success 1
   fw_setenv flag_boot_rootfs 1
   reboot
   ```

ä»è¾“å‡ºä¿¡æ¯æ¥çœ‹ï¼Œ`/dev/mtd13` çš„æ•°æ®åŒ…å«äº†ä¸€äº›å¯è¯»çš„æ ‡è¯†ç¬¦ï¼ˆä¾‹å¦‚ `UBI#`ã€`UBI!`ã€`kernel`ã€`ubi_rootfs` ç­‰ï¼‰ï¼Œä¹Ÿæœ‰ä¸€äº›æ··ä¹±çš„äºŒè¿›åˆ¶æ•°æ®å’Œå­—ç¬¦ã€‚è¿™è¡¨æ˜è¯¥åˆ†åŒºå¯èƒ½æ˜¯ä¸€ä¸ª  **UBIï¼ˆUnsorted Block Imageï¼‰æ ¼å¼çš„ NAND åˆ†åŒº** ï¼Œé‡Œé¢åŒ…å«å‹ç¼©æˆ–åŠ å¯†çš„æ•°æ®ã€‚

### åˆ¤æ–­æ˜¯å¦åŠ å¯†çš„æ–¹æ³•

1. **UBI æ ¼å¼** ï¼šUBI æ˜¯ä¸€ç§ç®¡ç† NAND é—ªå­˜çš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼ï¼Œå¯ä»¥å­˜å‚¨åŸå§‹æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ SquashFSï¼‰æˆ–å…¶ä»–ç±»å‹çš„æ•°æ®ã€‚è‹¥æ•°æ®æ˜¯ä»¥åŠ å¯†å½¢å¼å­˜å‚¨çš„ï¼Œè§£å‹åä»å¯èƒ½æ˜¯ä¸å¯è¯»çš„ã€‚
2. **æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ** ï¼š

* å¯ä»¥å°è¯•ä½¿ç”¨å·¥å…·æŒ‚è½½åˆ†åŒºæˆ–è€…æå–å†…å®¹ã€‚ä¾‹å¦‚ï¼š

  ```bash
  ubiattach /dev/ubi_ctrl -m 13
  mount -t ubifs /dev/ubi0_0 /mnt
  ```

  å¦‚æœæŒ‚è½½æˆåŠŸå¹¶èƒ½è®¿é—®å†…å®¹ï¼Œè¯´æ˜æ•°æ®æœªåŠ å¯†ã€‚
* å¦‚æœæ— æ³•æŒ‚è½½ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ–‡ä»¶ç³»ç»Ÿæœªè¯†åˆ«æˆ–å·²åŠ å¯†ã€‚

1. **è§£å¯†ç‰¹å¾** ï¼š

* æ–‡ä»¶å†…å®¹ä¸­æ²¡æœ‰æ˜æ˜¾çš„å­—ç¬¦ä¸²ï¼ˆå¦‚é…ç½®æ–‡ä»¶ã€è„šæœ¬ç­‰ï¼‰ã€‚
* æ•°æ®å¤šå‘ˆç°é«˜ç†µï¼ˆæ··ä¹±ã€éšæœºï¼‰çŠ¶æ€ï¼Œè¿™æ˜¯åŠ å¯†æ•°æ®çš„å…¸å‹ç‰¹å¾ã€‚

1. **å°è¯•è§£å‹ SquashFS** ï¼š
   è‹¥åˆ†åŒºæ˜¯å‹ç¼©è€ŒéåŠ å¯†çš„ï¼Œå¯ä»¥ä½¿ç”¨ `unsquashfs` å·¥å…·ï¼š

```bash
   unsquashfs -d ./output /dev/mtd13
```

   å¦‚æœæˆåŠŸæå–å†…å®¹ï¼Œè¯´æ˜æ•°æ®æœªåŠ å¯†ã€‚

1. **æŸ¥çœ‹ U-Boot é…ç½®** ï¼š
   æœ‰æ—¶è®¾å¤‡ä¼šåœ¨ U-Boot é˜¶æ®µå¯ç”¨åˆ†åŒºåŠ å¯†ï¼ˆå¦‚ä½¿ç”¨ AESï¼‰ã€‚å¯ä»¥æ£€æŸ¥æ˜¯å¦æœ‰åŠ å¯†æœºåˆ¶é…ç½®åœ¨å›ºä»¶ä¸­ã€‚

### ä¸‹ä¸€æ­¥å»ºè®®

* **å¤‡ä»½åˆ†åŒºæ•°æ®** ï¼šå…ˆç”¨ `dd` å¤‡ä»½åˆ†åŒºå†…å®¹ã€‚

```bash
  dd if=/dev/mtd13 of=backup_mtd13.img
```

* **åˆ†æå¤‡ä»½æ–‡ä»¶** ï¼šåœ¨å¤‡ä»½çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥å®éªŒï¼Œé¿å…ç ´ååŸå§‹æ•°æ®ã€‚
* **æ£€æŸ¥è®¾å¤‡æ–‡æ¡£** ï¼šæŸ¥é˜…ç›¸å…³æ–‡æ¡£ï¼Œçœ‹æ˜¯å¦æœ‰æåˆ°åˆ†åŒºåŠ å¯†æˆ–æ–‡ä»¶ç³»ç»Ÿçš„è¯¦ç»†ä¿¡æ¯ã€‚
* **å·¥å…·å°è¯•** ï¼šç”¨ `binwalk` æˆ– `strings` æ›´æ·±å…¥åˆ†æã€‚

```bash
  binwalk -e backup_mtd13.img
```

  è¯¥å·¥å…·å¯ä»¥è¯†åˆ«å‹ç¼©ç±»å‹æˆ–åŠ å¯†ç±»å‹ã€‚

Ubootåˆ·æœºï¼š

1ã€åˆ·å…¥ä¸´æ—¶OPå›ºä»¶ä¸ºåˆå¹¶åˆ†åŒºåšå‡†å¤‡ï¼ˆå‚ç…§æ‰©å®¹åˆ·æœºçš„ç¬¬äºŒæ­¥ï¼‰

2ã€ä½¿ç”¨winscpæŠŠ ax6-minbib.bin ä»¥åŠ uboot-redmi-ax6.bin ä¸Šä¼ åˆ°è·¯ç”±å™¨tmpç›®å½•

3ã€è¾“å…¥ä¸‹é¢å‘½ä»¤åˆ·å…¥æ‰©å®¹åˆ†åŒºè¡¨ã€åˆ·å…¥æ”¹ç‰ˆuboot

    mtd erase /dev/mtd1
     mtd write /tmp/ax6-mibib.bin /dev/mtd1

    mtd erase /dev/mtd7
     mtd write /tmp/uboot-redmi-ax6.bin /dev/mtd7

4ã€æ‹”ç”µæºé‡å¯

æˆ‘è¦æ‰©å®¹äº†

æ‰©å®¹åˆ·å…¥uboot æˆåŠŸ

å¦‚æœå…‰çŒ«ä½¿ç”¨ **SLAACï¼ˆæ— çŠ¶æ€åœ°å€è‡ªåŠ¨é…ç½®ï¼‰** æ¥åˆ†å‘ IPv6 åœ°å€ï¼Œé‚£ä¹ˆ OpenWrt çš„é…ç½®éœ€è¦ç‰¹åˆ«è°ƒæ•´ï¼Œå› ä¸º SLAAC çš„å·¥ä½œæœºåˆ¶ä¸ DHCPv6-PD ä¸åŒã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„é…ç½®æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹ï¼š

---

### SLAAC å·¥ä½œåŸç†

* SLAAC æ˜¯åŸºäºè·¯ç”±å™¨é€šå‘Šï¼ˆRAï¼ŒRouter Advertisementï¼‰çš„åè®®ã€‚
* å…‰çŒ«é€šè¿‡å‘é€ RA æŠ¥æ–‡å‘ŠçŸ¥ç½‘ç»œä¸­çš„è®¾å¤‡å¦‚ä½•è‡ªåŠ¨ç”Ÿæˆ IPv6 åœ°å€ã€‚
* OpenWrt éœ€è¦é…ç½®ä¸ºæ¥æ”¶ RA æŠ¥æ–‡ï¼Œå¹¶åŸºäº SLAAC è‡ªåŠ¨ç”Ÿæˆ IPv6 åœ°å€ã€‚

---

### é…ç½®æ­¥éª¤

#### 1. æ£€æŸ¥ OpenWrt WAN æ¥å£è®¾ç½®

ç¡®ä¿ OpenWrt çš„ WAN æ¥å£èƒ½å¤Ÿæ¥æ”¶ SLAAC åœ°å€ï¼š

1. ç™»å½• OpenWrt ç®¡ç†ç•Œé¢ï¼Œè¿›å…¥  **ç½‘ç»œ -> æ¥å£ -> WAN** ã€‚
2. æ£€æŸ¥ WAN çš„åè®®ç±»å‹ï¼š
   * å¦‚æœåè®®ä¸º `DHCPv6`ï¼Œè¯·æ”¹ä¸º `IPv6ï¼ˆä»…å®¢æˆ·ç«¯ï¼‰` æˆ–ç±»ä¼¼é€‰é¡¹ã€‚
   * å¦‚æœæ²¡æœ‰æ­¤é€‰é¡¹ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ `DHCPv6` åè®®ï¼Œå¹¶ç¡®ä¿ä»¥ä¸‹é€‰é¡¹å·²å¯ç”¨ï¼š
     * **æ¥æ”¶è·¯ç”±é€šå‘Šï¼ˆAccept RAï¼‰** ï¼šå¯ç”¨ã€‚
     * **è¯·æ±‚åœ°å€ï¼ˆRequest Addressï¼‰** ï¼šå¯ç”¨ã€‚
3. ä¿å­˜å¹¶åº”ç”¨ã€‚

#### 2. LAN æ¥å£é…ç½®

SLAAC æ¨¡å¼ä¸‹ï¼ŒLAN æ¥å£çš„ IPv6 åœ°å€ä¼šåŸºäºå…‰çŒ«ä¸‹å‘çš„ RA æŠ¥æ–‡è‡ªåŠ¨ç”Ÿæˆï¼š

1. è¿›å…¥  **ç½‘ç»œ -> æ¥å£ -> LAN** ã€‚
2. ç¡®ä¿ä»¥ä¸‹è®¾ç½®æ­£ç¡®ï¼š
   * **IPv6 åˆ†å‘ï¼š** å¯ç”¨ã€‚
   * **DHCPv6 æ¨¡å¼ï¼š** é€‰æ‹© `æœåŠ¡å™¨å’Œä¸­ç»§` æˆ– `ä¸­ç»§`ã€‚
3. ä¿å­˜å¹¶åº”ç”¨ã€‚

---

#### 3. é˜²ç«å¢™è®¾ç½®

ç¡®ä¿é˜²ç«å¢™å…è®¸ IPv6 æ•°æ®åŒ…è½¬å‘ï¼š

1. è¿›å…¥  **ç½‘ç»œ -> é˜²ç«å¢™ -> åŒºåŸŸè®¾ç½®** ï¼š
   * ç¡®ä¿ `LAN` å’Œ `WAN` åŒºåŸŸå¯ç”¨äº† IPv6 è½¬å‘ã€‚
2. æ·»åŠ è‡ªå®šä¹‰è§„åˆ™ï¼ˆå¯é€‰ï¼‰ï¼š
   ```bash
   ip6tables -A FORWARD -i br-lan -o eth2 -j ACCEPT
   ip6tables -A FORWARD -i eth2 -o br-lan -j ACCEPT
   ```

---

#### 4. æ£€æŸ¥è·¯ç”±å™¨æ˜¯å¦æ¥æ”¶ RA æŠ¥æ–‡

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ WAN æ¥å£æ˜¯å¦æ¥æ”¶åˆ°å…‰çŒ«çš„ RA æŠ¥æ–‡ï¼š

```bash
tcpdump -i eth2 icmp6 and ip6[40] == 134
```

è¾“å‡ºä¸­åº”è¯¥åŒ…å«æ¥è‡ªå…‰çŒ«çš„ RA æŠ¥æ–‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯èƒ½æ˜¯ï¼š

* å…‰çŒ«æœªå¯ç”¨ SLAACã€‚
* é˜²ç«å¢™è§„åˆ™é˜»æ­¢äº† RA æŠ¥æ–‡ã€‚

---

#### 5. éªŒè¯ IPv6 åœ°å€

1. æ£€æŸ¥ WAN æ¥å£çš„ IPv6 åœ°å€ï¼š

   ```bash
   ip -6 addr show eth2
   ```

   * åº”è¯¥çœ‹åˆ°åŸºäºå…‰çŒ«çš„å‰ç¼€ç”Ÿæˆçš„ IPv6 åœ°å€ï¼ˆä¾‹å¦‚ `2408::/64`ï¼‰ã€‚
2. æ£€æŸ¥ LAN æ¥å£æ˜¯å¦åˆ†å‘äº† SLAAC åœ°å€ï¼š

   ```bash
   ip -6 addr show br-lan
   ```
3. ç¡®è®¤å†…ç½‘è®¾å¤‡æ˜¯å¦èƒ½è·å–åˆ° SLAAC åœ°å€ï¼š

   * åœ¨å†…ç½‘è®¾å¤‡ä¸Šè¿è¡Œï¼š
     ```bash
     ip -6 addr show
     ```

---

### è§£å†³å¸¸è§é—®é¢˜

#### 1. æ— æ³•è·å– SLAAC åœ°å€

* æ£€æŸ¥å…‰çŒ«æ˜¯å¦å¯ç”¨äº† SLAACã€‚
* ç¡®ä¿ OpenWrt çš„ WAN æ¥å£å¯ç”¨äº†  **æ¥å— RA** ã€‚
* æ£€æŸ¥é˜²ç«å¢™è§„åˆ™æ˜¯å¦å…è®¸ RA æŠ¥æ–‡é€šè¿‡ã€‚

#### 2. å†…ç½‘è®¾å¤‡æ— æ³•è·å– IPv6 åœ°å€

* ç¡®ä¿ LAN æ¥å£å·²å¯ç”¨ IPv6 åˆ†å‘ã€‚
* æ£€æŸ¥è·¯ç”±å™¨æ˜¯å¦æ­£ç¡®æ¥æ”¶å…‰çŒ«çš„ RAï¼Œå¹¶è½¬å‘åˆ° LANã€‚

#### 3. æ’æŸ¥æ—¥å¿—

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ OpenWrt çš„ IPv6 é…ç½®å’Œæ—¥å¿—ï¼š

```bash
logread | grep odhcpd
logread | grep ra
```

---

fsku4VhmX-GtC27OIFcehXS5GXChiyXD_O9dQtSs

DDNS

ddns

ipv6.ftyiming.us.kg

åœ¨ OpenWrt ä¸­ï¼Œ`/etc/opkg/customfeeds.conf` å’Œ `/etc/opkg/distfeeds.conf` æ˜¯ä¸¤ä¸ªç”¨äºé…ç½®è½¯ä»¶åŒ…æºçš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„ä½œç”¨å’Œç”¨é€”æœ‰æ‰€ä¸åŒï¼š

---

### 1. **`/etc/opkg/distfeeds.conf`**

* **ç”¨é€”** :

  è¿™æ˜¯ OpenWrt å®˜æ–¹ç»´æŠ¤çš„é»˜è®¤è½¯ä»¶åŒ…æºé…ç½®æ–‡ä»¶ã€‚å®ƒåŒ…å«å®˜æ–¹ç‰ˆæœ¬å‘å¸ƒæ—¶é¢„è®¾çš„æºåœ°å€ï¼Œé€šå¸¸æŒ‡å‘ OpenWrt çš„å®˜æ–¹æœåŠ¡å™¨æˆ–é•œåƒç«™ã€‚
* **å†…å®¹** :

  é€šå¸¸å®šä¹‰äº†å„ç±»å®˜æ–¹è½¯ä»¶åŒ…æºï¼Œå¦‚ `core`ã€`base`ã€`luci`ã€`packages` ç­‰ã€‚ä¾‹å¦‚ï¼š

```plaintext
  src/gz openwrt_core https://downloads.openwrt.org/releases/23.05.0/targets/qualcommax/ipq807x/packages
  src/gz openwrt_base https://downloads.openwrt.org/releases/23.05.0/packages/aarch64_cortex-a53/base
  src/gz openwrt_luci https://downloads.openwrt.org/releases/23.05.0/packages/aarch64_cortex-a53/luci
```

* **ä¿®æ”¹å»ºè®®** :

  ä¸å»ºè®®ç›´æ¥ä¿®æ”¹è¯¥æ–‡ä»¶ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šåœ¨å›ºä»¶å‡çº§æˆ–ç³»ç»Ÿæ›´æ–°æ—¶è¢«è¦†ç›–ã€‚

---

### 2. **`/etc/opkg/customfeeds.conf`**

* **ç”¨é€”** :

  è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ­¤æ–‡ä»¶ä¸­æ·»åŠ ç¬¬ä¸‰æ–¹æºæˆ–è‡ªå®šä¹‰çš„åŒ…æºåœ°å€ï¼Œæ‰©å±•è½¯ä»¶åŒ…å®‰è£…çš„èƒ½åŠ›ã€‚
* **å†…å®¹** :

  é€šå¸¸ç”¨äºæ·»åŠ éå®˜æ–¹çš„è½¯ä»¶åŒ…æºã€‚ä¾‹å¦‚ï¼š

```plaintext
  src/gz custom_feed https://example.com/openwrt/packages
  src/gz my_feed https://myserver.com/openwrt/custom-packages
```

* **ä¿®æ”¹å»ºè®®** :

  ç”¨æˆ·å¯ä»¥è‡ªç”±ç¼–è¾‘æˆ–æ·»åŠ å†…å®¹ï¼Œä¸ä¼šå› ä¸ºå›ºä»¶å‡çº§è€Œè¢«è¦†ç›–ï¼Œé€‚åˆæ”¾ç½®ä¸ªäººç»´æŠ¤çš„æºæˆ–ç¬¬ä¸‰æ–¹æºåœ°å€ã€‚

---

### 3. **ä¸¤è€…çš„å…³ç³»**

* **ä¼˜å…ˆçº§** :

  ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„æºåœ°å€å…·æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ï¼Œ`opkg` ä¼šä¾æ¬¡æŸ¥è¯¢æ‰€æœ‰å®šä¹‰çš„æºåœ°å€ã€‚
* **ç”¨é€”åˆ’åˆ†** :
* `distfeeds.conf` é€‚ç”¨äºå®˜æ–¹ç»´æŠ¤çš„æºã€‚
* `customfeeds.conf` é€‚ç”¨äºç”¨æˆ·è‡ªå®šä¹‰çš„ç¬¬ä¸‰æ–¹æºã€‚

ä¾‹å¦‚ï¼š

* å®˜æ–¹æºé…ç½®æ”¾åœ¨ `distfeeds.conf`ã€‚
* ç¬¬ä¸‰æ–¹æ’ä»¶æºï¼ˆå¦‚ SSR+ï¼‰é…ç½®æ”¾åœ¨ `customfeeds.conf`ã€‚

---

### 4. **å¦‚ä½•ç®¡ç†è¿™ä¸¤ä¸ªæ–‡ä»¶**

* å¦‚æœåªéœ€ä¿®æ”¹å®˜æ–¹æºåœ°å€ï¼ˆå¦‚æ›´æ¢é•œåƒç«™ï¼‰ï¼Œç¼–è¾‘ `distfeeds.conf`ã€‚
* å¦‚æœéœ€æ·»åŠ æ–°çš„åŒ…æºæˆ–ç¬¬ä¸‰æ–¹æºï¼Œå»ºè®®å°†å…¶æ”¾åœ¨ `customfeeds.conf`ï¼Œä»¥ä¾¿ç®¡ç†å’Œç»´æŠ¤ã€‚

---

### 5. **å®é™…åº”ç”¨å»ºè®®**

åœ¨å®é™…ä½¿ç”¨ä¸­ï¼š

1. **æ›´æ¢é•œåƒç«™** :
   å¦‚æœåªæ˜¯å°†æºæ›¿æ¢ä¸ºé•œåƒç«™ï¼ˆå¦‚ TUNAï¼‰ï¼Œç›´æ¥ä¿®æ”¹ `distfeeds.conf`ï¼š

```bash
   sed -i 's|https://downloads.openwrt.org|https://mirrors.tuna.tsinghua.edu.cn/openwrt|' /etc/opkg/distfeeds.conf
```

1. **æ·»åŠ ç¬¬ä¸‰æ–¹æº** :
   å°†ç¬¬ä¸‰æ–¹æºæ·»åŠ åˆ° `customfeeds.conf`ï¼š

```bash
   echo 'src/gz custom_feed https://example.com/openwrt/packages' >> /etc/opkg/customfeeds.conf
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥æ›´æ¸…æ™°åœ°ç®¡ç†å®˜æ–¹æºå’Œè‡ªå®šä¹‰æºçš„é…ç½®ã€‚

ALGï¼ˆApplication Layer Gatewayï¼‰æ˜¯ä¸€ç§åœ¨è·¯ç”±å™¨æˆ–é˜²ç«å¢™ä¸­ç”¨æ¥ç¡®ä¿æŸäº›åº”ç”¨å±‚åè®®èƒ½å¤Ÿåœ¨ NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰ç¯å¢ƒä¸‹æ­£å¸¸è¿è¡Œçš„åŠŸèƒ½ã€‚ä¸åŒçš„ ALG åŠŸèƒ½å¯¹åº”ä¸åŒçš„åè®®ï¼Œç”¨äºè§£æå’Œå¤„ç†è¿™äº›åè®®ä¸­çš„åµŒå…¥å¼ IP åœ°å€æˆ–ç«¯å£ä¿¡æ¯ã€‚

ä»¥ä¸‹æ˜¯å„ä¸ªé€‰é¡¹çš„ä½œç”¨å’Œå»ºè®®ï¼š

1. **å¯ç”¨ L2TP ALG**
   * **ä½œç”¨** ï¼šç”¨äºå¤„ç† L2TPï¼ˆLayer 2 Tunneling Protocolï¼‰éš§é“åè®®ï¼Œç¡®ä¿ VPN è¿æ¥èƒ½é€šè¿‡ NATã€‚
   * **å»ºè®®** ï¼šå¦‚æœä½¿ç”¨ L2TP VPNï¼Œåˆ™å‹¾é€‰ï¼›å¦åˆ™å¯ä»¥å…³é—­ã€‚
2. **å¯ç”¨ IPSec ALG**
   * **ä½œç”¨** ï¼šä¸º IPSecï¼ˆInternet Protocol Securityï¼‰æä¾› NAT ç©¿è¶Šæ”¯æŒï¼Œå¤„ç† ESPï¼ˆEncapsulation Security Payloadï¼‰å’Œ IKEï¼ˆInternet Key Exchangeï¼‰æ•°æ®ã€‚
   * **å»ºè®®** ï¼šå¦‚æœä½¿ç”¨ IPSec VPNï¼Œåˆ™å‹¾é€‰ï¼›å¦åˆ™å…³é—­ã€‚
3. **å¯ç”¨ H.323 ALG**
   * **ä½œç”¨** ï¼šH.323 æ˜¯ä¸€ç§ç”¨äºè§†é¢‘ä¼šè®®ã€VoIP ç­‰çš„åè®®ï¼ŒALG æ”¯æŒå¯ç¡®ä¿è¿™äº›æœåŠ¡åœ¨ NAT ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œã€‚
   * **å»ºè®®** ï¼šå¦‚æœä½¿ç”¨ H.323 çš„è§†é¢‘æˆ–éŸ³é¢‘æœåŠ¡ï¼Œåˆ™å‹¾é€‰ï¼›å¦åˆ™å…³é—­ã€‚
4. **å¯ç”¨ RTSP ALG**
   * **ä½œç”¨** ï¼šä¸º RTSPï¼ˆReal Time Streaming Protocolï¼‰æä¾›æ”¯æŒï¼Œç¡®ä¿å®æ—¶æµåª’ä½“ä¼ è¾“åœ¨ NAT ç¯å¢ƒä¸­èƒ½æ­£ç¡®å¤„ç†ç«¯å£ã€‚
   * **å»ºè®®** ï¼šå¦‚æœç»å¸¸ä½¿ç”¨æµåª’ä½“æœåŠ¡ï¼ˆå¦‚ç›‘æ§è®¾å¤‡æˆ–è§†é¢‘æ’­æ”¾ï¼‰ï¼Œå‹¾é€‰ï¼›å¦åˆ™å…³é—­ã€‚
5. **å¯ç”¨ SIP ALG**
   * **ä½œç”¨** ï¼šä¸º SIPï¼ˆSession Initiation Protocolï¼‰æä¾›æ”¯æŒï¼Œç¡®ä¿ VoIP å‘¼å«å¯ä»¥é€šè¿‡ NATã€‚
   * **å»ºè®®** ï¼šå¾ˆå¤šæƒ…å†µä¸‹ SIP ALG å¯èƒ½å¯¼è‡´ VoIP é—®é¢˜ï¼Œé™¤éæ˜ç¡®éœ€è¦ï¼Œå¦åˆ™å…³é—­ã€‚
6. **å¯ç”¨ FTP ALG**
   * **ä½œç”¨** ï¼šä¸º FTPï¼ˆFile Transfer Protocolï¼‰æä¾›æ”¯æŒï¼Œè§£å†³ä¸»åŠ¨ FTP åœ¨ NAT ç¯å¢ƒä¸‹çš„è¿æ¥é—®é¢˜ã€‚
   * **å»ºè®®** ï¼šå¦‚æœéœ€è¦ä½¿ç”¨ä¸»åŠ¨ FTPï¼Œåˆ™å‹¾é€‰ï¼›å¦åˆ™å…³é—­ã€‚
7. **å¯ç”¨ PPTP ALG**
   * **ä½œç”¨** ï¼šä¸º PPTPï¼ˆPoint-to-Point Tunneling Protocolï¼‰VPN æä¾› NAT ç©¿è¶Šæ”¯æŒã€‚
   * **å»ºè®®** ï¼šå¦‚æœä½¿ç”¨ PPTP VPNï¼Œåˆ™å‹¾é€‰ï¼›å¦åˆ™å…³é—­ã€‚

---

### æ€»ç»“ï¼š

æ˜¯å¦éœ€è¦å¯ç”¨ ALG å–å†³äºä½ å…·ä½“çš„ç½‘ç»œä½¿ç”¨åœºæ™¯ã€‚å¦‚æœæŸäº›åº”ç”¨æˆ–æœåŠ¡åœ¨ NAT ç¯å¢ƒä¸‹æ— æ³•æ­£å¸¸å·¥ä½œï¼Œå¯ä»¥å°è¯•å‹¾é€‰ç›¸åº”çš„ ALG åŠŸèƒ½ã€‚ä½† **ä¸å»ºè®®å…¨é€‰** ï¼Œå› ä¸ºå¼€å¯ä¸å¿…è¦çš„ ALG å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™æˆ–æ„å¤–çš„ç½‘ç»œé—®é¢˜ã€‚

å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ç½‘ç»œæ€§èƒ½ï¼Œå»ºè®®ï¼š

1. å°½é‡ä½¿ç”¨ UPnP æˆ–æ‰‹åŠ¨ç«¯å£æ˜ å°„æ›¿ä»£ ALGã€‚
2. æ£€æŸ¥ä½¿ç”¨çš„å…·ä½“åè®®ï¼Œé’ˆå¯¹æ€§åœ°å¼€å¯ç›¸å…³é€‰é¡¹ã€‚

åˆ‡æ¢80ç«¯å£åˆ°5680 LuCI - OpenWrt Configuration Interface

vi /etc/config/uhttpd

/etc/init.d/uhttpd restart

åœ¨ OpenWrt ä¸Šé…ç½®è‡ªç­¾å SSL è¯ä¹¦å¹¶é€šè¿‡ 56443 ç«¯å£è®¿é—® HTTPSï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

---

### 1. **ç”Ÿæˆè‡ªç­¾å SSL è¯ä¹¦**

1. ä½¿ç”¨ SSH ç™»å½•åˆ°è·¯ç”±å™¨ã€‚

   ```bash
   ssh root@192.168.1.1
   ```
2. æ£€æŸ¥æ˜¯å¦å®‰è£…äº† `openssl` å·¥å…·åŒ…ï¼š

   ```bash
   opkg update
   opkg install openssl-util
   ```
3. ç”Ÿæˆè‡ªç­¾åè¯ä¹¦å’Œç§é’¥ï¼š

   ```bash
   mkdir -p /etc/ssl/private
   openssl req -x509 -newkey rsa:2048 -keyout /etc/ssl/private/luci.key -out /etc/ssl/private/luci.crt -days 365 -nodes -subj "/C=CN/ST=State/L=City/O=Organization/OU=Unit/CN=OpenWrt"
   ```

   * `/etc/ssl/private/luci.key` æ˜¯ç§é’¥æ–‡ä»¶ã€‚
   * `/etc/ssl/private/luci.crt` æ˜¯è¯ä¹¦æ–‡ä»¶ã€‚
   * `-days 365` è®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸä¸º 1 å¹´ã€‚

---

### 2. **é…ç½® uhttpd ä½¿ç”¨ SSL å’Œ 56443 ç«¯å£**

1. ç¼–è¾‘ `uhttpd` é…ç½®æ–‡ä»¶ï¼š

   ```bash
   vi /etc/config/uhttpd
   ```
2. ä¿®æ”¹æˆ–æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

   ```plaintext
   option listen_https '0.0.0.0:56443'
   option cert '/etc/ssl/private/luci.crt'
   option key '/etc/ssl/private/luci.key'
   ```

   å¦‚æœä½ å¸Œæœ›ä»…å¯ç”¨ HTTPSï¼Œå¯ä»¥æ³¨é‡Šæˆ–åˆ é™¤ `option listen_http` çš„é…ç½®è¡Œã€‚
3. ä¿å­˜å¹¶é€€å‡ºï¼ˆæŒ‰ `ESC` é”®ï¼Œç„¶åè¾“å…¥ `:wq`ï¼‰ã€‚

---

### 3. **é‡å¯ uhttpd æœåŠ¡**

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åº”ç”¨æ›´æ”¹ï¼š

```bash
/etc/init.d/uhttpd restart
```

---

### 4. **é€šè¿‡ HTTPS è®¿é—® LuCI**

åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ï¼š

```plaintext
https://<è·¯ç”±å™¨IP>:56443
```

ä¾‹å¦‚ï¼š

```plaintext
https://192.168.1.1:56443
```

---

### 5. **è§£å†³æµè§ˆå™¨å®‰å…¨è­¦å‘Šï¼ˆå¯é€‰ï¼‰**

ç”±äºè‡ªç­¾åè¯ä¹¦ä¸æ˜¯ç”±å—ä¿¡ä»»çš„ CA ç­¾å‘ï¼Œæµè§ˆå™¨ä¼šæç¤ºâ€œä¸å®‰å…¨â€æˆ–æ˜¾ç¤ºå®‰å…¨è­¦å‘Šã€‚ä½ å¯ä»¥é€‰æ‹©æ‰‹åŠ¨ä¿¡ä»»è¯ä¹¦ï¼š

1. ç‚¹å‡»æµè§ˆå™¨çš„é«˜çº§é€‰é¡¹ã€‚
2. é€‰æ‹©â€œç»§ç»­è®¿é—®â€æˆ–å°†è¯ä¹¦æ·»åŠ åˆ°ç³»ç»Ÿçš„ä¿¡ä»»åˆ—è¡¨ä¸­ï¼ˆæµè§ˆå™¨å…·ä½“æ“ä½œå› å“ç‰Œè€Œå¼‚ï¼‰ã€‚

---

å®Œæˆåï¼Œä½ åº”è¯¥èƒ½å¤Ÿé€šè¿‡ HTTPS å’Œ 56443 ç«¯å£å®‰å…¨è®¿é—® LuCI ç®¡ç†ç•Œé¢ã€‚

logread | grep uhttpd | less

```
uci set zerotier.global.enabled='1'
uci delete zerotier.earth
uci set zerotier.mynet=network
uci set zerotier.mynet.id=<abfd31bd47eb4d4a>
uci commit zerotier
service zerotier restart
```

AX6NSS-qualcommax-6.x-nss-wifi

ç°åœ¨ç”¨çš„è¿™ä¸ªå›ºä»¶

Actions-Redmi-AX6  ä¸€å‘¨æ„å»ºä¸€æ¬¡

è¿™äº› OpenWrt å›ºä»¶æ–‡ä»¶é€‚ç”¨äº  **Redmi AX6** ï¼ˆ **IPQ8071A** ï¼‰ï¼Œä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š

### 1. **initramfs vs squashfs**

* **initramfs** ï¼šä¸´æ—¶è¿è¡Œçš„ RAMDisk å›ºä»¶ï¼Œé€‚ç”¨äºæµ‹è¯•æˆ–è§£é”åé¦–æ¬¡åˆ·å…¥ï¼ˆé€šå¸¸ä¸å¸¦æŒä¹…åŒ–å­˜å‚¨ï¼‰ã€‚
* **squashfs** ï¼šå¸¦æœ‰ **åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ** çš„æ ‡å‡† OpenWrt å›ºä»¶ï¼Œé€‚ç”¨äºé•¿æœŸä½¿ç”¨ã€‚

### 2. **factory vs sysupgrade**

* **factory** ï¼šç”¨äº**ä»åŸå‚å›ºä»¶åˆ·å…¥ OpenWrt** æˆ–  **é€šè¿‡ U-Boot TFTP æ¢å¤åˆ·æœº** ï¼Œé€šå¸¸æ˜¯ **.ubi** æ ¼å¼ã€‚
* **sysupgrade** ï¼šç”¨äº  **å·²æœ‰ OpenWrt çš„è®¾å¤‡å‡çº§** ï¼Œæ ¼å¼ä¸€èˆ¬ä¸º  **.bin** ã€‚

### 3. **æ–‡ä»¶å…·ä½“ä½œç”¨**

| æ–‡ä»¶å                                                           | è¯´æ˜                                   | é€‚ç”¨åœºæ™¯                                                               |
| ---------------------------------------------------------------- | -------------------------------------- | ---------------------------------------------------------------------- |
| `openwrt-qualcommax-ipq807x-redmi_ax6-initramfs-factory.ubi`   | **å·¥å‚ç‰ˆ initramfs å›ºä»¶**        | **è§£é”åä¸´æ—¶å¯åŠ¨ OpenWrt** ï¼ˆç”¨äºè§£é” SSH æˆ–è¿›å…¥ OpenWrtï¼‰       |
| `openwrt-qualcommax-ipq807x-redmi_ax6-initramfs-uImage.itb`    | **initramfs è¿è¡Œçš„ uImage å›ºä»¶** | U-Boot æˆ–æŸäº›ç‰¹æ®Šå¼•å¯¼æ–¹å¼ä½¿ç”¨                                          |
| `openwrt-qualcommax-ipq807x-redmi_ax6-squashfs-factory.ubi`    | **å·¥å‚ç‰ˆ squashfs å›ºä»¶**         | **ä»åŸå‚å›ºä»¶åˆ·å…¥ OpenWrt** ï¼ˆé€šè¿‡ U-Boot TFTP æˆ– Web æ¢å¤ï¼‰      |
| `openwrt-qualcommax-ipq807x-redmi_ax6-squashfs-sysupgrade.bin` | **sysupgrade ç‰ˆ squashfs å›ºä»¶**  | **å·²åˆ· OpenWrt åçš„å‡çº§** ï¼ˆé€šè¿‡ `sysupgrade`æŒ‡ä»¤æˆ– Web å‡çº§ï¼‰ |
| `openwrt-qualcommax-ipq807x-redmi_ax6.manifest`                | è¯¥ç‰ˆæœ¬çš„å›ºä»¶**åŒ…å«çš„è½¯ä»¶åŒ…åˆ—è¡¨** | ä»…ç”¨äºå‚è€ƒï¼Œä¸æ˜¯åˆ·æœºæ–‡ä»¶                                               |

---

### **ä½ è¯¥æ€ä¹ˆé€‰ï¼Ÿ**

* **ä»åŸå‚åˆ· OpenWrtï¼ˆé¦–æ¬¡åˆ·æœºï¼‰** â†’ `openwrt-qualcommax-ipq807x-redmi_ax6-squashfs-factory.ubi`
* **ä¸´æ—¶å¯åŠ¨ OpenWrtï¼ˆæµ‹è¯•/è§£é”ï¼‰** â†’ `openwrt-qualcommax-ipq807x-redmi_ax6-initramfs-factory.ubi`
* **å·²ç»æ˜¯ OpenWrtï¼Œæƒ³å‡çº§** â†’ `openwrt-qualcommax-ipq807x-redmi_ax6-squashfs-sysupgrade.bin`

å¦‚æœä½ æ˜¯ **ç¬¬ä¸€æ¬¡åˆ· OpenWrt** ï¼Œé€šå¸¸éœ€è¦ `factory.ubi` æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ TFTP æ–¹å¼åˆ·å…¥ã€‚

å¤‡ä»½ä¸€ä¸‹ è®¾ç½® çœ‹çœ‹ä¿ç•™è®¾ç½®æ€ä¹ˆæ ·  ä¸ä¿ç•™äº†

`192.168.2.1` æ— å¯†ç 

* (æ›´æ–°)å› ä¸ºå†…å­˜å¯¼è‡´çš„luciå¡æ­»é—®é¢˜ä¼¼ä¹ä¿®å¤äº†(è‡³å°‘æˆ‘å¼€æœºå¥½å‡ å¤©æ²¡è§luciå´©æºƒäº†)ï¼Œ~~ä¸è¿‡ç”±äº5.15å†…æ ¸æºç çš„åŸå› ï¼Œå¼€ä¸äº†160Mhz~~
* (å†æ¬¡æ›´æ–°)è‹¥è¦å¼€160Mhzè¯·åœ¨ç½‘ç»œ-æ— çº¿é¡¹ç›®æ‰¾åˆ°Generic 802.11acaxnï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå°†ä¿¡é“è®¾ç½®æˆ48(äº²æµ‹å¯ç”¨ï¼Œä¹Ÿå¯ä»¥å°è¯•å…¶å®ƒä¿¡é“)ï¼Œç„¶ååœ¨é«˜çº§è®¾ç½®ä¸‹æŠŠå›½å®¶è®¾ç½®ä¸ºUS - United Statesï¼Œä¿å­˜å¹¶åº”ç”¨è®¾ç½®ï¼Œç­‰å¾…ä¸€åˆ†é’Ÿå·¦å³å³å¯

![1738290640756](RA69/1738290640756.png)

è¿˜æ˜¯è™šæ‹Ÿwanå£

* æµè§ˆå™¨è¿›å…¥192.168.1.1ï¼Œåˆ·å…¥***-initramfs-factory.ubi
* æ”¹å›DHCPï¼Œè¿›å…¥è·¯ç”±å™¨åå°ï¼ŒæŒ‰ç…§[å¦‚ä½•æ›´æ–°å›ºä»¶](tutorial/ru-he-geng-xin-gu-jian.md)åˆ·å…¥***-squashfs-sysupgrade.bin

ä¸æ”¯æŒ å§æ§½ é‚£æˆ‘uboot å»192.168.1.1

dH6tN$5z)ec5m$a

LEAD çš„å›ºä»¶è¿˜æ˜¯192.168.1.1

å¯ä»¥è¿›å»

## DDNS

Custom update URL

https://api.cloudflare.com/client/v4/user/tokens/verify

# https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/5edce1126269d157a5b75f8fda1c384f

ZONE_ID å’Œ RECORD_ID å¯ä»¥é€šè¿‡ Cloudflare API æˆ–é€šè¿‡ Cloudflare çš„æ§åˆ¶å°æ‰¾åˆ°ï¼š

ZONE_ID: åœ¨ Cloudflare ä»ªè¡¨ç›˜ç‚¹å‡»ä½ åŸŸåçš„é¡µé¢ï¼ŒURL ä¸­åŒ…å«çš„ zone åé¢çš„é•¿å­—ç¬¦ä¸²å³ä¸º ZONE_IDã€‚ d3fec629e04c52c5d7923afaa6654ef0

RECORD_ID: åœ¨ DNS è®¾ç½®é¡µé¢ä¸­æ‰¾åˆ°ä½ éœ€è¦æ›´æ–°çš„è®°å½•ï¼Œé€šè¿‡ API æˆ–è€… UI æ¥æŸ¥çœ‹æ­¤ IDã€‚

```
17d971746d20de8f4cd3112dbb11d3b6
```

![1738378178405](RA69/1738378178405.png)

Username: è¾“å…¥ä½ çš„ Cloudflare æ³¨å†Œé‚®ç®±åœ°å€ã€‚  ftyiming@outlook.com

Password: è¾“å…¥ä½ åˆšåˆšåˆ›å»ºçš„ API Tokenã€‚  72d081643cf1927faff51db53fd71e6bfed23

ipv6.ftyiming.us.kg

æ”¹ä¸€ä¸‹urlè·å–ipv6

æ‰‹åŠ¨æµ‹è¯• Cloudflare API

curl -X GET "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/d3fec629e04c52c5d7923afaa6654ef0"
    -H "X-Auth-Email: ftyiming@outlook.com"
    -H "X-Auth-Key: 72d081643cf1927faff51db53fd71e6bfed23"
    -H "Content-Type: application/json"

* **å¦‚æœè¿”å› `200` å¹¶ä¸”æœ‰ DNS è®°å½•ä¿¡æ¯ï¼Œè¯´æ˜ API Key æ­£ç¡®ã€‚**
* **å¦‚æœè¿”å› `403`ï¼Œè¯´æ˜ API Key ä¸å¯¹ï¼Œæˆ–è€…æƒé™ä¸è¶³ã€‚**
* **å¦‚æœè¿”å› `404`ï¼Œè¯´æ˜ DNS è®°å½• ID (`17d971746d20de8f4cd3112dbb11d3b6`) ä¸å¯¹ã€‚**

root@LEDE:~# curl -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \

> -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn"
> -H "Content-Type:application/json"
> {"result":{"id":"3ec2586fb881fbe8a402d4bab4a90bf6","status":"active","expires_on":"2025-10-11T23:59:59Z"},"success":true,"errors":[],"messages":[{"code":10000,"message":"This API Token is valid and active","type":null}]}root@LEDE:~#

å¥½çš„ï¼Œè¿™æ˜¯æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯ç¼–å†™çš„æ—¥å¿—ï¼š

## åŠ¨æ€ DNS (DDNS) æ›´æ–°æ—¥å¿—

dnsid 5edce1126269d157a5b75f8fda1c384f

**æ—¥æœŸ:** 2025-02-04

**æ—¶é—´:** 03:05

**è®¾å¤‡:** (æ­¤å¤„å¡«å†™æ‚¨çš„è®¾å¤‡åç§°æˆ–å‹å·)

**DDNS æœåŠ¡:** Cloudflare

**åŸŸå:** ftyiming.us.kg (IPv6)

### æ—¥å¿—è¯¦æƒ…

* 03:00 - DDNS å®¢æˆ·ç«¯å¯åŠ¨ï¼Œå°è¯•æ›´æ–° DNS è®°å½•ã€‚
* 03:00 - 03:02 - ç”±äº `nslookup` å‘½ä»¤æ— æ³•è§£æåŸŸå ftyiming.us.kgï¼Œæ›´æ–°å°è¯•å¤±è´¥ã€‚é”™è¯¯ä¿¡æ¯ï¼šâ€œBusyBox nslookup error: '1'â€ã€‚
* 03:02 - é‡æ–°é…ç½® DDNS å®¢æˆ·ç«¯ï¼Œè°ƒæ•´é‡è¯•é—´éš”å’Œæ¬¡æ•°ã€‚
* 03:05 - DDNS å®¢æˆ·ç«¯æˆåŠŸæ£€æµ‹åˆ°æ–°çš„ IPv6 åœ°å€ï¼š`2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee`ã€‚
* 03:05 - DDNS å®¢æˆ·ç«¯ä½¿ç”¨ `wget` å‘½ä»¤è¿æ¥åˆ° Cloudflare APIï¼ŒæˆåŠŸæ›´æ–° DNS è®°å½•ã€‚
* 03:05 - DDNS æ›´æ–°å®Œæˆï¼ŒçŠ¶æ€æ˜¾ç¤ºä¸ºâ€œæˆåŠŸâ€ã€‚

### é—®é¢˜åˆ†æ

* æœ€åˆçš„æ›´æ–°å¤±è´¥æ˜¯ç”±äº `nslookup` å‘½ä»¤æ— æ³•è§£æåŸŸåã€‚è¿™å¯èƒ½æ˜¯ç”±äºç½‘ç»œè¿æ¥é—®é¢˜ã€DNS æœåŠ¡å™¨æ•…éšœæˆ–é˜²ç«å¢™é˜»æ­¢ DNS è¯·æ±‚ç­‰åŸå› é€ æˆçš„ã€‚
* é‡æ–°é…ç½® DDNS å®¢æˆ·ç«¯åï¼Œé—®é¢˜å¾—åˆ°è§£å†³ã€‚å¯èƒ½æ˜¯ç”±äºç½‘ç»œè¿æ¥æ¢å¤æ­£å¸¸ï¼Œæˆ–è€… DDNS å®¢æˆ·ç«¯ä½¿ç”¨äº†å¤‡ç”¨çš„ DNS æœåŠ¡å™¨ã€‚
* æœ€ç»ˆçš„æ›´æ–°å°è¯•ä½¿ç”¨ `wget` å‘½ä»¤ç›´æ¥ä¸ Cloudflare API é€šä¿¡ï¼Œç»•è¿‡äº† `nslookup` å‘½ä»¤ï¼Œå› æ­¤æˆåŠŸå®Œæˆã€‚

### ç»“è®º

æœ¬æ¬¡ DDNS æ›´æ–°è¿‡ç¨‹è™½ç„¶é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œä½†æœ€ç»ˆæˆåŠŸå®Œæˆã€‚å»ºè®®å®šæœŸæ£€æŸ¥ DDNS å®¢æˆ·ç«¯çš„é…ç½®å’Œæ—¥å¿—ï¼Œä»¥ç¡®ä¿ DNS è®°å½•å§‹ç»ˆä¿æŒæœ€æ–°ã€‚

### å¤‡æ³¨

* æœ¬æ¬¡æ—¥å¿—è®°å½•äº† IPv6 åœ°å€çš„æ›´æ–°è¿‡ç¨‹ã€‚
* æ‚¨å¯ä»¥æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹æ—¥å¿—å†…å®¹ï¼Œä¾‹å¦‚æ·»åŠ è®¾å¤‡ä¿¡æ¯ã€æ•…éšœæ’é™¤æ­¥éª¤ç­‰ã€‚

å¸Œæœ›è¿™ä»½æ—¥å¿—å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼

nslookup å‡ºé”™æ˜¯å› ä¸º wanå£æ²¡é…ç½®dns å’Œ ç½‘å…³

![1739079453315](RA69/1739079453315.png)

è‡ªå®šä¹‰ é“¾æ¥ https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/d3fec629e04c52c5d7923afaa6654ef0

å¯†ç    value="GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn"

030253  WARN : Get registered/public IP for 'ipv6.ftyiming.us.kg' failed after 1 retries - TERMINATE
 030253  WARN : PID '16718' exit WITH ERROR '1' at 2025-02-04 03:02
 030503       : ************ ************** ************** **************
 030503  note : PID '17545' started at 2025-02-04 03:05
 030503       : ddns version  : 2.8.2-52
 030503       : uci configuration:
ddns.myddns_ipv6.check_interval='1'
ddns.myddns_ipv6.check_unit='hours'
ddns.myddns_ipv6.domain='ftyiming.us.kg'
ddns.myddns_ipv6.enabled='1'
ddns.myddns_ipv6.force_interval='24'
ddns.myddns_ipv6.force_unit='hours'
ddns.myddns_ipv6.interface='wan6'
ddns.myddns_ipv6.ip_network='wan6'
ddns.myddns_ipv6.ip_source='network'
ddns.myddns_ipv6.lookup_host='ipv6.ftyiming.us.kg'
ddns.myddns_ipv6.password='***PW***'
ddns.myddns_ipv6.retry_interval='5'
ddns.myddns_ipv6.retry_max_count='1'
ddns.myddns_ipv6.retry_unit='seconds'
ddns.myddns_ipv6.update_url='https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/d3fec629e04c52c5d7923afaa6654ef0'
ddns.myddns_ipv6.use_ipv6='1'
ddns.myddns_ipv6.use_syslog='2'
ddns.myddns_ipv6.username='ftyiming@outlook.com'
ddns.myddns_ipv6=service
 030503       : verbose mode  : 0 - run normal, NO console output
 030503       : check interval: 3600 seconds
 030503       : force interval: 86400 seconds
 030503       : retry interval: 5 seconds
 030503       : retry max count : 1 times
 030503       : No old process
 030503       : last update: never
 030503       : Detect registered/public IP
 030503       : #> /usr/bin/nslookup ipv6.ftyiming.us.kg  >/var/run/ddns/myddns_ipv6.dat 2>/var/run/ddns/myddns_ipv6.err
 030504       : Registered IP '2409:8a3c:5b60:c670::2' detected
 030504  info : Starting main loop at 2025-02-04 03:05
 030504       : Detect current IP on 'network'
 030504       : Current IP '2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee' detected on network 'wan6'
 030504       : Update needed - L: '2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee' <> R: '2409:8a3c:5b60:c670:0000:0000:0000:0002'
 030504       : Force communication via IP '2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee'
 030504       : #> /usr/bin/wget --hsts-file=/tmp/.wget-hsts -nv -t 1 -O /var/run/ddns/myddns_ipv6.dat -o /var/run/ddns/myddns_ipv6.err --bind-address=2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee --no-proxy 'https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/d3fec629e04c52c5d7923afaa6654ef0'

curl -X PUT "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/d3fec629e04c52c5d7923afaa6654ef0"
    -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn"
    -H "Content-Type: application/json"
    --data '{"type":"AAAA","name":"ipv6.ftyiming.us.kg","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","ttl":120,"proxied":false}'

curl -X PUT "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/5edce1126269d157a5b75f8fda1c384f"
    -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn"
    -H "Content-Type: application/json"
    --data '{"type":"AAAA","name":"ipv6.ftyiming.us.kg","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","ttl":120,"proxied":false}'

curl -X PUT "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/d3fec629e04c52c5d7923afaa6654ef0"
    -H "Authorization: GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn"
    -H "Content-Type: application/json"
    --data '{"type":"AAAA","name":"ipv6.ftyiming.us.kg","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","ttl":120,"proxied":false}'

ä½ çš„ Cloudflare API è¯·æ±‚è¿”å›äº† `81044: Record does not exist`ï¼Œè¯´æ˜ **Cloudflare æ‰¾ä¸åˆ°è¿™ä¸ª DNS è®°å½•**ã€‚å¯èƒ½çš„åŸå› æœ‰ï¼š

---

## **1. ç¡®ä¿ `dns_record_id` æ­£ç¡®**

ä½ çš„ `dns_record_id`ï¼ˆ`d3fec629e04c52c5d7923afaa6654ef0`ï¼‰å¯èƒ½ä¸å¯¹ï¼Œæˆ–è€…è¿™ä¸ªè®°å½•å·²ç»è¢«åˆ é™¤ã€‚ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è·å–æ‰€æœ‰ DNS è®°å½•çš„ IDï¼Œæ‰¾åˆ°æ­£ç¡®çš„ `dns_record_id`ï¼š

```sh
curl -X GET "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records" \
     -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn" \
     -H "Content-Type: application/json"
```

### **è¾“å‡ºç¤ºä¾‹**

å¦‚æœä½ çš„ `AAAA` è®°å½•å­˜åœ¨ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼çš„è¿”å›ï¼š

```json
{
  "result": [
    {
      "id": "new_record_id_123456",
      "type": "AAAA",
      "name": "ipv6.ftyiming.us.kg",
      "content": "2409:8a3c:5b6c:xxxx",
      "ttl": 120
    }
  ],
  "success": true
}
```

æ‰¾åˆ°æ­£ç¡®çš„ `id`ï¼Œç„¶åæ›´æ–° API è¯·æ±‚ï¼š

```sh
curl -X PUT "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/new_record_id_123456" \
     -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn" \
     -H "Content-Type: application/json" \
     --data '{"type":"AAAA","name":"ipv6.ftyiming.us.kg","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","ttl":120,"proxied":false}'
```

---

## **2. ç¡®ä¿ `AAAA` è®°å½•å·²ç»å­˜åœ¨**

å¦‚æœ `GET /dns_records` æ²¡æœ‰è¿”å›ä»»ä½• AAAA è®°å½•ï¼Œè¯´æ˜è¿™ä¸ªè®°å½•ä¸å­˜åœ¨ï¼Œä½ éœ€è¦ **æ–°å»º** è€Œä¸æ˜¯æ›´æ–°ï¼š

```sh
curl -X POST "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records" \
     -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn" \
     -H "Content-Type: application/json" \
     --data '{"type":"AAAA","name":"ipv6.ftyiming.us.kg","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","ttl":120,"proxied":false}'
```

**æˆåŠŸå Cloudflare ä¼šè¿”å›æ–°çš„ `id`ï¼Œç„¶åä½ æ‰èƒ½ç”¨ `PUT` æ›´æ–°ã€‚**

---

## **3. ç¡®ä¿ `zone_id` æ­£ç¡®**

ä½ çš„ `zone_id` å¯èƒ½ä¸å¯¹ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤è·å– **ä½ çš„åŸŸåçš„æ­£ç¡® `zone_id`**ï¼š

```sh
curl -X GET "https://api.cloudflare.com/client/v4/zones" \
     -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn" \
     -H "Content-Type: application/json"
```

ç„¶åæ£€æŸ¥è¿”å›çš„ `id` æ˜¯å¦å’Œ `17d971746d20de8f4cd3112dbb11d3b6` ä¸€è‡´ã€‚

---

## **4. æ£€æŸ¥ API Token æƒé™**

å¦‚æœä½ ä»ç„¶é‡åˆ°é—®é¢˜ï¼Œæ£€æŸ¥ API Token æ˜¯å¦æœ‰ **Zone â†’ DNS Edit** æƒé™ï¼Œå¦åˆ™æ— æ³•æ›´æ–° DNS è®°å½•ï¼š

- è¿›å…¥ [Cloudflare API Tokens](https://dash.cloudflare.com/profile/api-tokens)
- åˆ›å»ºæ–°çš„ Tokenï¼Œå¹¶ç»™å®ƒ **Zone:DNS Edit** æƒé™

---

## **æ€»ç»“**

1. **å…ˆç”¨ `GET /dns_records` ç¡®è®¤ `AAAA` è®°å½•çš„ ID æ˜¯å¦æ­£ç¡®**
2. **å¦‚æœè®°å½•ä¸å­˜åœ¨ï¼Œç”¨ `POST` åˆ›å»º**
3. **æ£€æŸ¥ `zone_id` æ˜¯å¦æ­£ç¡®**
4. **ç¡®è®¤ API Token å…·æœ‰ `Zone:DNS Edit` æƒé™**

å…ˆè¯•è¯•çœ‹ `GET /dns_records`ï¼Œçœ‹çœ‹ Cloudflare è¿”å›çš„ `id` æ˜¯ä¸æ˜¯æ­£ç¡®çš„ï¼ğŸš€

root@LEDE:~# curl -X PUT "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/5edce1126269d157a5b75f8fda1c384f" \

> -H "Authorization: Bearer GM98a5m6M7rNKMWu31AU3nx5tfRJi4yGZLuwDFmn"
> -H "Content-Type: application/json"
> --data '{"type":"AAAA","name":"ipv6.ftyiming.us.kg","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","ttl":120,"proxied":false}'
> {"result":{"id":"5edce1126269d157a5b75f8fda1c384f","name":"ipv6.ftyiming.us.kg","type":"AAAA","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","proxiable":true,"proxied":false,"ttl":120,"settings":{},"meta":{},"comment":null,"tags":[],"created_on":"2024-07-27T12:07:39.94685Z","modified_on":"2025-02-09T06:21:45.391595Z"},"success":true,"errors":[],"messages":[]}root@LEDE:~#

213702       : #> /usr/bin/wget --hsts-file=/tmp/.wget-hsts -nv -t 1 -O /var/run/ddns/myddns_ipv6.dat -o /var/run/ddns/myddns_ipv6.err --bind-address=2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee --no-proxy 'https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/5edce1126269d157a5b75f8fda1c384f'

failed: Address family not supported by protocol.
failed: Operation timed out.

æˆ‘ä¹Ÿæ˜¯é‡åˆ°è¿™ä¸ªé”™è¯¯ï¼Œæ˜¨å¤©èŠ±äº†ä¸€ä¸ªæ™šä¸Šè§£å†³äº†ï¼Œæ˜¯wgetä¸æ”¯æŒ--bind-address ipv6çš„é—®é¢˜ï¼Œæˆ‘çš„opç‰ˆæœ¬åœ¨/usr/lib/ddns/dynamic_dns_functions.shä¸­æ³¨é‡Šæ‰

#__PROG="$__PROG --bind-address=$__BINDIP"è¿™è¡Œå°±å¯ä»¥äº†ã€‚

å…¶ä»–å¯¹åº”ç‰ˆæœ¬æ‰¾åˆ°ç›¸åº”çš„è„šæœ¬ï¼Œæ³¨é‡Šæ‰æ·»åŠ --bind-addressé€‰é¡¹çš„ä»£ç ã€‚

ä½ ç°åœ¨é‡åˆ°çš„æ˜¯ `wget` è¿”å›çš„ **HTTP 400: Bad Request** é”™è¯¯ï¼Œé€šå¸¸è¡¨ç¤ºè¯·æ±‚æ ¼å¼æœ‰é—®é¢˜ã€‚ä¹‹å‰ `--bind-address` çš„é—®é¢˜å·²ç»ç»•è¿‡äº†ï¼Œä½†ç°åœ¨å¯èƒ½æ˜¯  **Cloudflare API è¯·æ±‚æ ¼å¼é”™è¯¯** ã€‚

---

## **1. ç¡®ä¿ API è¯·æ±‚æ­£ç¡®**

ä½ å½“å‰ `update_url` æ˜¯ï¼š

```sh
https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/5edce1126269d157a5b75f8fda1c384f
```

è¿™ä¸ª URL  **åªé€‚ç”¨äº GET æŸ¥è¯¢** ï¼Œä½† **æ›´æ–° DNS è®°å½•** éœ€è¦ä½¿ç”¨ `PUT` æ–¹æ³•ï¼Œå¹¶å¸¦ä¸Š JSON æ•°æ®ã€‚

### **æ­£ç¡®çš„ `curl` å‘½ä»¤ï¼ˆCloudflare API æ›´æ–° IPv6 åœ°å€ï¼‰**

åœ¨ OpenWrt é‡Œè¿è¡Œï¼š

```sh
curl -X PUT "https://api.cloudflare.com/client/v4/zones/17d971746d20de8f4cd3112dbb11d3b6/dns_records/5edce1126269d157a5b75f8fda1c384f" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_CLOUDFLARE_API_TOKEN" \
     --data '{"type":"AAAA","name":"ipv6.ftyiming.us.kg","content":"2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee","ttl":1,"proxied":false}'
```

 **æ³¨æ„ä¿®æ”¹ `Authorization` é‡Œçš„ `YOUR_CLOUDFLARE_API_TOKEN`** ï¼Œä½¿ç”¨ä½ çš„  **Cloudflare API ä»¤ç‰Œ** ï¼ˆéœ€è¦æœ‰ DNS ç¼–è¾‘æƒé™ï¼‰ã€‚

å¦‚æœ `curl` è¿”å› `success: true`ï¼Œè¡¨ç¤º API è¯·æ±‚æ­£ç¡®ã€‚

---

## **2. ä¿®æ”¹ OpenWrt DDNS é…ç½®**

ä½ çš„ `update_url` ç›´æ¥ä½¿ç”¨äº† `wget`ï¼Œä½† `wget`  **ä¸æ”¯æŒ `PUT` æ–¹æ³•** ï¼Œæ‰€ä»¥éœ€è¦ï¼š

1. **æ”¹ç”¨ `curl`**
2. **æ‰‹åŠ¨æ‹¼æ¥ API è¯·æ±‚**

### **ä¿®æ”¹ `/etc/config/ddns`**

è¿è¡Œï¼š

```sh
vi /etc/config/ddns
```

æ‰¾åˆ° `config service 'myddns_ipv6'` éƒ¨åˆ†ï¼Œä¿®æ”¹ï¼š

```sh
option use_curl '1'
option update_url 'https://api.cloudflare.com/client/v4/zones/YOUR_ZONE_ID/dns_records/YOUR_RECORD_ID'
option update_script '/usr/lib/ddns/update_cloudflare.sh'
```

/usr/lib/ddns/update_cloudflare.sh

è„šæœ¬è·¯å¾„æ²¡äº†

ç„¶ååˆ›å»º `update_cloudflare.sh` è„šæœ¬ï¼š

```sh
vi /usr/lib/ddns/update_cloudflare.sh
```

å†…å®¹ï¼š

```sh
#!/bin/sh
CLOUDFLARE_API_TOKEN="ä½ çš„ API ä»¤ç‰Œ"
ZONE_ID="17d971746d20de8f4cd3112dbb11d3b6"
RECORD_ID="5edce1126269d157a5b75f8fda1c384f"
IPV6_ADDR="$1"

curl -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
     --data "{\"type\":\"AAAA\",\"name\":\"ipv6.ftyiming.us.kg\",\"content\":\"$IPV6_ADDR\",\"ttl\":1,\"proxied\":false}"
```

ç„¶åèµ‹äºˆå¯æ‰§è¡Œæƒé™ï¼š

```sh
chmod +x /usr/lib/ddns/update_cloudflare.sh
```

---

## **3. é‡å¯ DDNS**

```sh
/etc/init.d/ddns restart
```

ç„¶åæ£€æŸ¥æ—¥å¿—ï¼š

```sh
logread -e ddns
```

å¦‚æœè¿”å› `success: true`ï¼Œè¯´æ˜ Cloudflare æ›´æ–°æˆåŠŸï¼ğŸ‰

---

### **æ€»ç»“**

* `wget`  **ä¸æ”¯æŒ PUT è¯·æ±‚** ï¼Œå¯¼è‡´ 400 é”™è¯¯
* `curl`  **å¯ä»¥å‘é€ JSON æ•°æ®** ï¼Œç”¨å®ƒæ¥æ›´æ–° Cloudflare
* **ä¿®æ”¹ OpenWrt DDNS é…ç½®** ï¼Œè®©å®ƒè°ƒç”¨ `update_cloudflare.sh`
* **æ‰‹åŠ¨æµ‹è¯• `curl` å‘½ä»¤** ç¡®ä¿ API ä»¤ç‰Œå’Œè¯·æ±‚æ ¼å¼æ­£ç¡®

è¿™æ ·åº”è¯¥å°±èƒ½æˆåŠŸæ›´æ–° IPv6 è®°å½•äº†ï¼ğŸš€

220128  note : PID '8503' started at 2025-02-09 22:01
 220128       : ddns version  : 2.8.2-52
 220128       : uci configuration:
ddns.myddns_ipv6.check_interval='1'
ddns.myddns_ipv6.check_unit='hours'
ddns.myddns_ipv6.domain='ftyiming.us.kg'
ddns.myddns_ipv6.enabled='1'
ddns.myddns_ipv6.force_interval='24'
ddns.myddns_ipv6.force_unit='hours'
ddns.myddns_ipv6.interface='wan6'
ddns.myddns_ipv6.ip_network='wan6'
ddns.myddns_ipv6.ip_source='network'
ddns.myddns_ipv6.lookup_host='ipv6.ftyiming.us.kg'
ddns.myddns_ipv6.password='***PW***'
ddns.myddns_ipv6.retry_interval='5'
ddns.myddns_ipv6.retry_max_count='1'
ddns.myddns_ipv6.retry_unit='seconds'
ddns.myddns_ipv6.update_script='/usr/lib/ddns/update_cloudflare.sh'
ddns.myddns_ipv6.update_url='https://api.cloudflare.com/client/v4/zones/YOUR_ZONE_ID/dns_records/YOUR_RECORD_ID'
ddns.myddns_ipv6.use_curl='1'
ddns.myddns_ipv6.use_ipv6='1'
ddns.myddns_ipv6.use_syslog='2'
ddns.myddns_ipv6.username='ftyiming@outlook.com'
ddns.myddns_ipv6=service
 220128       : verbose mode  : 0 - run normal, NO console output
 220128       : check interval: 3600 seconds
 220128       : force interval: 86400 seconds
 220128       : retry interval: 5 seconds
 220128       : retry max count : 1 times
 220128       : No old process
 220128       : last update: never
 220128       : Detect registered/public IP
 220128       : #> /usr/bin/nslookup ipv6.ftyiming.us.kg  >/var/run/ddns/myddns_ipv6.dat 2>/var/run/ddns/myddns_ipv6.err
 220131       : Registered IP '2409:8a3c:5b60:c670::2' detected
 220131  info : Starting main loop at 2025-02-09 22:01
 220131       : Detect current IP on 'network'
 220131       : Current IP '2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee' detected on network 'wan6'
 220131       : Update needed - L: '2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee' <> R: '2409:8a3c:5b60:c670:0000:0000:0000:0002'
 220131       : parsing script '/usr/lib/ddns/update_cloudflare.sh'
 220133  info : Update successful - IP '2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee' send
 220133  info : Forced update successful - IP: '2409:8a3c:5b6c:d540:3ecd:57ff:fe6a:b0ee' send
 220133       : Waiting 3600 seconds (Check Interval)

æˆåŠŸäº†ï¼Ÿ

### **3. å½»åº•å±è”½ `wget`ï¼Œåªå…è®¸ `curl`**

å¦‚æœ `wget` ä»ç„¶åœ¨æ—¥å¿—ä¸­æŠ¥é”™ï¼Œå¯ä»¥ç”¨  **è½¯é“¾æ¥å±è”½ `wget`** ï¼š

mv /usr/bin/wget /usr/bin/wget.bak
ln -s /usr/bin/curl /usr/bin/wget

logread -e ddns

opkg update

é˜²ç«å¢™  å’Œ ç®¡ç†æƒé™




## shell openwrt ä¸Šè·¯

ip -6 neigh show


åœ¨ OpenWrt ä¸Šï¼Œ`uhttpd` æ˜¯é»˜è®¤çš„ Web æœåŠ¡å™¨ï¼ˆç”¨äº LuCI ç®¡ç†ç•Œé¢ï¼‰ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹ç™»å½•æ—¥å¿—ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š

---

### **1. æŸ¥çœ‹ uhttpd ç›¸å…³æ—¥å¿—**

`uhttpd` é»˜è®¤ä¸ä¼šå•ç‹¬è®°å½•è®¿é—®æ—¥å¿—ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ `logread` è¿‡æ»¤ç›¸å…³æ—¥å¿—ï¼š

```sh
logread | grep uhttpd
```

å¦‚æœæƒ³å®æ—¶ç›‘æ§ï¼š

```sh
logread -f | grep uhttpd
```

---

### **2. æŸ¥çœ‹ LuCI ç™»å½•æ—¥å¿—**

LuCI ç™»å½•è®¤è¯å¤±è´¥æˆ–æˆåŠŸçš„æ—¥å¿—é€šå¸¸å­˜å‚¨åœ¨ `logread` é‡Œï¼Œä½¿ç”¨ï¼š

```sh
logread | grep -i luci
```

å¦‚æœä½ æƒ³ç­›é€‰å‡ºå¤±è´¥çš„å°è¯•ï¼š

```sh
logread | grep -i 'failed\|invalid'
```

å¸¸è§çš„æ—¥å¿—ç¤ºä¾‹ï¼š

```
Jan 26 12:34:56 LEDE authpriv.notice uhttpd[1234]: Failed login attempt for root from 192.168.1.100
Jan 26 12:35:10 LEDE authpriv.notice uhttpd[1234]: Successful login for root from 192.168.1.100
```

è¿™æ ·ä½ å¯ä»¥çœ‹åˆ°å“ªäº› IP è®¿é—®äº† LuCIï¼Œæ˜¯å¦æœ‰å¤±è´¥çš„å°è¯•ã€‚

---

### **3. å¯ç”¨ uhttpd è®¿é—®æ—¥å¿—**

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`uhttpd`  **ä¸ä¼šè®°å½•è®¿é—®æ—¥å¿—** ï¼Œä½†ä½ å¯ä»¥æ‰‹åŠ¨å¯ç”¨å®ƒï¼š

1. ç¼–è¾‘ `uhttpd` é…ç½®æ–‡ä»¶ï¼š
   ```sh
   vi /etc/config/uhttpd
   ```
2. æ‰¾åˆ° `option log`ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ ï¼š
   ```sh
   option log '/var/log/uhttpd.log'
   ```
3. é‡æ–°å¯åŠ¨ `uhttpd`ï¼š
   ```sh
   /etc/init.d/uhttpd restart
   ```

ç„¶åä½ å¯ä»¥ä½¿ç”¨ï¼š

```sh
tail -f /var/log/uhttpd.log
```

æ¥æŸ¥çœ‹ Web è®¿é—®æ—¥å¿—ã€‚

---

### **4. ç»“åˆ iptables ç›‘æ§ LuCI è®¿é—®**

å¦‚æœä½ æƒ³ç›‘æ§è°è®¿é—®äº† LuCIï¼ˆ80/443 ç«¯å£ï¼‰ï¼Œå¯ä»¥ç”¨ `iptables` è®°å½•ï¼š

```sh
iptables -I INPUT -p tcp --dport 80 -j LOG --log-prefix "LUCI_ACCESS: "
iptables -I INPUT -p tcp --dport 443 -j LOG --log-prefix "LUCI_ACCESS: "
```

ç„¶åä½¿ç”¨ï¼š

```sh
dmesg | grep LUCI_ACCESS
```

logread | grep -i 'failed\|invalid'


åœ¨ LEDEï¼ˆOpenWrtï¼‰ä¸Šï¼Œå°† DNS è§£ææœåŠ¡å™¨æŒ‡å®šä¸º `192.168.1.1`ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼è¿›è¡Œé…ç½®ï¼š

---

## **æ–¹æ³• 1ï¼šä¿®æ”¹ `resolv.conf`ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼‰**
ä½ å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ `/etc/resolv.conf`ï¼ŒæŒ‡å®š `192.168.1.1` ä¸º DNS æœåŠ¡å™¨ï¼š
```sh
echo "nameserver 192.168.1.1" > /etc/resolv.conf
```
ä½† **è¿™ç§æ–¹æ³•ä¼šåœ¨è®¾å¤‡é‡å¯æˆ–ç½‘ç»œé‡è¿æ—¶è¢«è¦†ç›–**ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨æ–¹æ³• 2 æˆ– 3ã€‚

---

## **æ–¹æ³• 2ï¼šä½¿ç”¨ `uci` é…ç½®ï¼ˆæ¨èï¼Œæ°¸ä¹…ç”Ÿæ•ˆï¼‰**
ä¿®æ”¹ OpenWrt çš„ `network` é…ç½®ï¼ŒæŒ‡å®š `192.168.1.1` ä½œä¸º DNS æœåŠ¡å™¨ï¼š

```sh
uci set network.wan.peerdns='0'        # ç¦ç”¨è‡ªåŠ¨è·å– DNS
uci set network.wan.dns='192.168.1.1'  # è®¾ç½®è‡ªå®šä¹‰ DNS
uci commit network
/etc/init.d/network restart            # é‡å¯ç½‘ç»œä½¿é…ç½®ç”Ÿæ•ˆ
```
ç„¶åæ£€æŸ¥ `/etc/resolv.conf` æ˜¯å¦å·²æ­£ç¡®æ›´æ–°ï¼š
```sh
cat /etc/resolv.conf
```

## æ–¹æ³•æ— æ•ˆ

 
---

## **æ–¹æ³• 3ï¼šé…ç½® `dnsmasq`ï¼ˆå¦‚æœä½ æƒ³è®©æœ¬æœº `dnsmasq` è§£ææ—¶ä½¿ç”¨ 192.168.1.1ï¼‰**
å¦‚æœä½ å¸Œæœ› LEDE çš„ `dnsmasq` ä»£ç† DNS æŸ¥è¯¢åˆ° `192.168.1.1`ï¼Œå¯ä»¥ä¿®æ”¹ `/etc/config/dhcp`ï¼š
```sh
uci set dhcp.@dnsmasq[0].server='192.168.1.1'
uci commit dhcp
/etc/init.d/dnsmasq restart
```

ç„¶åæµ‹è¯•ï¼š
```sh
nslookup ipv6.ftyiming.us.kg 192.168.1.1
```

---

## **éªŒè¯**
æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç¡®è®¤ DNS è§£ææ˜¯å¦èµ° `192.168.1.1`ï¼š
```sh
nslookup ipv6.ftyiming.us.kg
```
æˆ–è€…ï¼š
```sh
cat /etc/resolv.conf
```

å¦‚æœ `resolv.conf` æ˜¾ç¤º `nameserver 192.168.1.1`ï¼Œè¯´æ˜é…ç½®æˆåŠŸã€‚

**æ€»ç»“**
- **æ–¹æ³• 1** é€‚ç”¨äºä¸´æ—¶æµ‹è¯•ï¼Œé‡å¯ä¼šå¤±æ•ˆã€‚
- **æ–¹æ³• 2** é€‚ç”¨äº WAN å£ï¼Œé¿å… DHCP è·å–å…¶ä»– DNSã€‚
- **æ–¹æ³• 3** é€‚ç”¨äº `dnsmasq`ï¼Œè®© LEDE æœ¬åœ° DNS è§£æä½¿ç”¨ `192.168.1.1`ã€‚

**æ¨èæ–¹æ³• 2 æˆ– 3ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©ï¼**